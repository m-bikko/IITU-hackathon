{% extends "base.html" %}

{% block title %}SmartAla - –ù–∞–≤–∏–≥–∞—Ü–∏—è{% endblock %}

{% block content %}
<div class="navigation-container">
    <header class="nav-header">
        <h1>üß≠ –£–º–Ω–∞—è –ù–∞–≤–∏–≥–∞—Ü–∏—è</h1>
        <p id="statusText">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞—Å–∞</p>
    </header>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="control-panel">
        <div class="control-group">
            <button id="calibrateBtn" class="control-btn primary" onclick="startCompassCalibration()">
                üß≠ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–ø–∞—Å
            </button>
            <button id="captureBtn" class="control-btn secondary" onclick="captureView()" disabled>
                üì∏ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </button>
            <button id="getCurrentLocationBtn" class="control-btn" onclick="getMyCurrentLocation()">
                üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            </button>
        </div>
        
        <div class="control-group">
            <button id="saveLocationBtn" class="control-btn success" onclick="saveCurrentLocationOnMap()" disabled>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ
            </button>
            <button id="clearMapBtn" class="control-btn warning" onclick="clearMap()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É
            </button>
        </div>
    </div>

    <!-- Google Maps –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="map-container">
        <div id="map" class="leaflet-map"></div>
        <div class="map-controls">
            <div class="map-info">
                <div id="selectedLocationInfo" class="location-info hidden">
                    <h4>üìç –í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ</h4>
                    <p id="selectedCoords">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å</p>
                    <input type="text" id="locationName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞..." class="location-input">
                    <textarea id="locationDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." class="location-input"></textarea>
                    <select id="locationCategory" class="location-input">
                        <option value="general">–û–±—â–µ–µ</option>
                        <option value="home">–î–æ–º</option>
                        <option value="work">–†–∞–±–æ—Ç–∞</option>
                        <option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
                        <option value="medical">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
                        <option value="education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="transport">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                        <option value="food">–ï–¥–∞</option>
                        <option value="entertainment">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                    </select>
                    <button onclick="saveSelectedLocation()" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</button>
                    <button onclick="clearSelection()" class="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ -->
    <div class="saved-locations-section">
        <h3>üìç –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</h3>
        <div id="savedLocationsList" class="saved-locations-grid">
            <!-- –ú–µ—Å—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –ú–∞—Ä—à—Ä—É—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="routeInfo" class="route-info hidden">
        <h3>üõ£Ô∏è –ú–∞—Ä—à—Ä—É—Ç</h3>
        <div id="routeDetails"></div>
        <button onclick="startNavigation()" class="nav-btn">üß≠ –ù–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é</button>
    </div>
</div>

<!-- Destination data for auto-navigation -->
{% if destination %}
<script>
    window.destinationData = {{ destination | tojsonfilter | safe }};
</script>
{% endif %}

<style>
    .navigation-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .nav-header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }

    .nav-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: white;
    }

    .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .control-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 15px 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        min-width: 160px;
    }

    .control-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .control-btn:disabled {
        background: linear-gradient(45deg, #9e9e9e, #757575);
        cursor: not-allowed;
        opacity: 0.6;
    }

    .control-btn.primary {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .control-btn.primary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .control-btn.secondary {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .control-btn.secondary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }

    .control-btn.success {
        background: linear-gradient(45deg, #FF9800, #F57C00);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .control-btn.success:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
    }

    .control-btn.warning {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .control-btn.warning:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }

    .map-container {
        position: relative;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        overflow: hidden;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .leaflet-map {
        width: 100%;
        height: 600px;
        border-radius: 20px;
    }

    .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        pointer-events: none;
        z-index: 1000;
    }

    .map-info {
        pointer-events: auto;
    }

    .location-info {
        background: rgba(255,255,255,0.95);
        color: #333;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        backdrop-filter: blur(10px);
        max-width: 350px;
    }

    .location-info h4 {
        margin: 0 0 15px 0;
        font-size: 1.3em;
        color: #2c3e50;
    }

    .location-input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .location-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .save-btn, .cancel-btn, .nav-btn {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
    }

    .cancel-btn {
        background: linear-gradient(45deg, #f44336, #d32f2f);
    }

    .nav-btn {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        font-size: 1.2em;
        padding: 15px 30px;
    }

    .save-btn:hover, .cancel-btn:hover, .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .saved-locations-section {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
    }

    .saved-locations-section h3 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8em;
        color: white;
    }

    .saved-locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    .saved-location-card {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .saved-location-card:hover {
        transform: translateY(-3px);
        background: rgba(255,255,255,0.2);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .saved-location-card h4 {
        margin: 0 0 10px 0;
        color: white;
        font-size: 1.3em;
    }

    .saved-location-card p {
        margin: 0 0 10px 0;
        color: rgba(255,255,255,0.8);
        font-size: 0.9em;
    }

    .location-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.05);
    }

    .route-info {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        text-align: center;
    }

    .route-info h3 {
        margin-bottom: 20px;
        color: white;
        font-size: 1.8em;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .control-group {
            justify-content: center;
        }
        
        .control-btn {
            min-width: 140px;
            padding: 12px 20px;
            font-size: 1em;
        }
        
        .leaflet-map {
            height: 400px;
        }
        
        .location-info {
            max-width: 280px;
        }
    }
</style>

<script>
    let map;
    let currentLocationMarker;
    let selectedLocationMarker;
    let routePolyline;
    let currentUserLocation = null;
    let selectedLocation = null;
    let savedLocations = [];
    let savedLocationMarkers = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
    let isCompassCalibrated = false;
    let isDirectionCaptured = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    function initMaps() {
        console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Leaflet –∫–∞—Ä—Ç—ã...');
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Leaflet:', typeof L);
        console.log('üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', window.destinationData);
        
        if (typeof L === 'undefined') {
            console.error('‚ùå Leaflet –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            speakText('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }
        
        initializeLeafletMap();
        loadSavedLocations();
        
        // –ü–†–û–í–ï–†–ö–ê –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
        if (window.destinationData) {
            console.log('üéØ –°–¢–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–°–´–õ–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê!');
            console.log('üìä –î–∞–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', window.destinationData);
            
            // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ–±—ä—è–≤–ª—è–µ–º –æ –Ω–∞—á–∞–ª–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å
            speakText(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –º–µ—Å—Ç–∞ ${window.destinationData.name}. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.`);
            
            // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–Ω–∞–≤–∏–≥–∞—Ü–∏—é
            setTimeout(() => {
                createDestinationMarker();
                startDirectNavigation(); // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è - –ø—Ä—è–º–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            }, 1000);
            
        } else {
            console.log('‚ÑπÔ∏è –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
            speakText('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–º–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é! –î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞—Å–∞.');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Leaflet –∫–∞—Ä—Ç—ã
    function initializeLeafletMap() {
        try {
            console.log('üó∫Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã Leaflet...');
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –ê–ª–º–∞—Ç—ã
            map = L.map('map').setView([43.238293, 76.889709], 13);
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞:', map);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è OpenStreetMap
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            console.log('‚úÖ –°–ª–æ–π –∫–∞—Ä—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω:', tileLayer);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                console.log('üëÜ –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ:', e.latlng);
                selectLocationOnMap(e.latlng);
            });

            // –ö–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ - —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
            map.whenReady(function() {
                console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞!');
                if (window.destinationData) {
                    console.log('üéØ –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã');
                    createDestinationMarker();
                }
            });

            console.log('‚úÖ Leaflet –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            speakText('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            requestUserLocation();

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            speakText('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã');
        }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    function createDestinationMarker() {
        console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º createDestinationMarker...');
        
        if (!window.destinationData) {
            console.log('‚ùå window.destinationData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            return;
        }
        
        if (!map) {
            console.log('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 500–º—Å');
            setTimeout(createDestinationMarker, 500);
            return;
        }
        
        console.log('üìä –î–∞–Ω–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', window.destinationData);

        const destination = {
            lat: parseFloat(window.destinationData.latitude),
            lng: parseFloat(window.destinationData.longitude)
        };
        
        console.log('üìç –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', destination);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        if (isNaN(destination.lat) || isNaN(destination.lng)) {
            console.error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã!', destination);
            return;
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
        if (selectedLocationMarker) {
            console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä');
            map.removeLayer(selectedLocationMarker);
        }

        try {
            console.log('üéØ –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö:', destination.lat, destination.lng);
            
            // –ü—Ä–æ—Å—Ç–æ–π —è—Ä–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
            selectedLocationMarker = L.marker([destination.lat, destination.lng], {
                icon: L.divIcon({
                    html: '<div style="background: #FF0000; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 4px solid white; font-size: 24px; font-weight: bold; box-shadow: 0 4px 15px rgba(255,0,0,0.5);">üéØ</div>',
                    className: 'destination-marker-big',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                })
            });
            
            console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É...');
            selectedLocationMarker.addTo(map);
            console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É!');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            selectedLocation = destination;
            console.log('‚úÖ selectedLocation —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', selectedLocation);

            // Popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            const popupContent = `
                <div style="text-align: center; font-weight: bold; min-width: 200px;">
                    <div style="color: #FF0000; font-size: 18px; margin-bottom: 8px;">
                        üéØ ${window.destinationData.name}
                    </div>
                    <div style="margin: 5px 0; color: #333;">
                        ${window.destinationData.description || '–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        üìç ${destination.lat.toFixed(6)}, ${destination.lng.toFixed(6)}
                    </div>
                    <div style="margin-top: 8px; padding: 4px 8px; background: #FF0000; color: white; border-radius: 12px; font-size: 11px;">
                        üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
                    </div>
                </div>
            `;
            
            selectedLocationMarker.bindPopup(popupContent);
            console.log('‚úÖ Popup —Å–æ–∑–¥–∞–Ω');
            
            // –°–†–ê–ó–£ –æ—Ç–∫—Ä—ã–≤–∞–µ–º popup
            selectedLocationMarker.openPopup();
            console.log('‚úÖ Popup –æ—Ç–∫—Ä—ã—Ç');

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º
            map.setView([destination.lat, destination.lng], 17);
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ');

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('selectedCoords').textContent = 
                `–®–∏—Ä–æ—Ç–∞: ${destination.lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${destination.lng.toFixed(6)}`;
            document.getElementById('selectedLocationInfo').classList.remove('hidden');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            document.getElementById('locationName').value = window.destinationData.name;
            document.getElementById('locationDescription').value = window.destinationData.description || '';
            document.getElementById('locationCategory').value = window.destinationData.category || 'general';
            
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
            document.getElementById('saveLocationBtn').disabled = true;
            document.getElementById('saveLocationBtn').textContent = '‚úÖ –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';

            speakText(`–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ${window.destinationData.name} –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ${destination.lat.toFixed(3)}, ${destination.lng.toFixed(3)}`);
            
            console.log('üéâ –ú–∞—Ä–∫–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω!');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞:', error);
            speakText('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ');
        }
    }

    // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function requestUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // –£–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–ù–ï –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è!)
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }

                    // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: linear-gradient(45deg, #4CAF50, #45a049); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 3px solid white; 
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                animation: pulse 2s infinite;
                                font-size: 18px;
                            ">üìç
                            </div>
                            <style>
                            @keyframes pulse {
                                0% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                                50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6); }
                                100% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                            }
                            </style>`,
                            className: 'current-location-icon',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(map);

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                    currentLocationMarker.bindPopup(`
                        <div style="text-align: center; font-weight: bold;">
                            <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                            <div style="font-size: 12px; color: #666;">
                                –®–∏—Ä–æ—Ç–∞: ${currentUserLocation.lat.toFixed(6)}<br>
                                –î–æ–ª–≥–æ—Ç–∞: ${currentUserLocation.lng.toFixed(6)}
                            </div>
                        </div>
                    `);

                    console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω');
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', selectedLocationMarker ? '–ï—Å—Ç—å' : '–ù–ï–¢!');

                    // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è - –ù–ï –£–î–ê–õ–Ø–ï–ú –µ–≥–æ!
                    if (selectedLocation && selectedLocationMarker) {
                        console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞');
                        
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Ç–∞–∫ —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞
                        const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                        
                        // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        
                        if (window.destinationData) {
                            speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–∞—Ä—à—Ä—É—Ç –∫ –º–µ—Å—Ç—É ${window.destinationData.name} –ø–æ—Å—Ç—Ä–æ–µ–Ω. –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é.`);
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                            setTimeout(() => {
                                startNavigation();
                            }, 2000);
                        } else {
                            speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ. –°—Ç—Ä–æ—é –º–∞—Ä—à—Ä—É—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—Ç—É.`);
                        }
                    } else if (selectedLocation && !selectedLocationMarker) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å selectedLocation –Ω–æ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ - –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                        console.warn('‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—è–Ω, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º...');
                        if (window.destinationData) {
                            createDestinationMarker();
                        }
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                    } else {
                        // –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                        map.setView([currentUserLocation.lat, currentUserLocation.lng], 15);
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ. –®–∏—Ä–æ—Ç–∞ ${currentUserLocation.lat.toFixed(3)}, –¥–æ–ª–≥–æ—Ç–∞ ${currentUserLocation.lng.toFixed(3)}. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.`);
                    }
                },
                function(error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –¥–ª—è –ª—É—á—à–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GPS –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                            break;
                        default:
                            errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                            break;
                    }
                    speakText(errorMessage + ' –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
                    maximumAge: 30000  // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –∫—ç—à–∞
                }
            );
        } else {
            speakText('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ –≤—Ä—É—á–Ω—É—é.');
        }
    }

    // –í—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    function selectLocationOnMap(latlng) {
        selectedLocation = {
            lat: latlng.lat,
            lng: latlng.lng
        };

        // –í–ê–ñ–ù–û: –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ - –ù–ï –ü–ï–†–ï–ó–ê–ü–ò–°–´–í–ê–ï–ú –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è!
        if (window.destinationData) {
            console.log('üö´ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ - –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏');
            speakText('–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏');
            return;
        }

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
        }

        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
        selectedLocationMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
            icon: L.divIcon({
                html: '<div style="background: #FF5722; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üìç</div>',
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ
        document.getElementById('selectedCoords').textContent = 
            `–®–∏—Ä–æ—Ç–∞: ${selectedLocation.lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${selectedLocation.lng.toFixed(6)}`;
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('saveLocationBtn').disabled = false;

        speakText(`–ú–µ—Å—Ç–æ –≤—ã–±—Ä–∞–Ω–æ. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${selectedLocation.lat.toFixed(3)}, ${selectedLocation.lng.toFixed(3)}`);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
        if (currentUserLocation) {
            calculateAndDisplayRoute(currentUserLocation, selectedLocation);
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–∞—Å–∞
    function startCompassCalibration() {
        speakText('–ù–∞—á–∏–Ω–∞—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –∫–æ–º–ø–∞—Å–∞. –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≤–∏–¥–µ –≤–æ—Å—å–º—ë—Ä–∫–∏.');
        document.getElementById('statusText').textContent = '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞... –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≤–∏–¥–µ –≤–æ—Å—å–º—ë—Ä–∫–∏';
        document.getElementById('calibrateBtn').disabled = true;

        // –°–∏–º—É–ª—è—Ü–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞—Å–∞
        setTimeout(() => {
            fetch('/calibrate_compass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'calibrate' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isCompassCalibrated = true;
                    document.getElementById('statusText').textContent = '–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.';
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('calibrateBtn').textContent = '‚úÖ –ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
                    speakText('–ö–æ–º–ø–∞—Å —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:', error);
                document.getElementById('calibrateBtn').disabled = false;
                speakText('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            });
        }, 3000);
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function captureView() {
        if (!isCompassCalibrated) {
            speakText('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–ø–∞—Å');
            return;
        }

        speakText('–û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞ —Å –ø–æ–º–æ—â—å—é –∫–∞–º–µ—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞');
        document.getElementById('statusText').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...';
        document.getElementById('captureBtn').disabled = true;

        // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞—Ö–≤–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        setTimeout(() => {
            fetch('/capture_view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'capture' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isDirectionCaptured = true;
                    document.getElementById('statusText').textContent = '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ! –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é.';
                    document.getElementById('captureBtn').textContent = '‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    speakText('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', error);
                document.getElementById('captureBtn').disabled = false;
                speakText('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            });
        }, 2000);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞)
    function getMyCurrentLocation() {
        console.log('üîò –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"');
        speakText('–û–±–Ω–æ–≤–ª—è—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
        document.getElementById('statusText').textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        const button = document.getElementById('getCurrentLocationBtn');
        const originalText = button.textContent;
        button.textContent = '‚è≥ –ü–æ–∏—Å–∫...';
        button.disabled = true;

        // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        if (!navigator.geolocation) {
            console.error('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            speakText('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
            button.textContent = originalText;
            button.disabled = false;
            return;
        }

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:', position.coords);
                
                currentUserLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // –£–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–ù–ï –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è!)
                if (currentLocationMarker) {
                    console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è');
                    map.removeLayer(currentLocationMarker);
                }

                // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                    icon: L.divIcon({
                        html: `<div style="
                            background: linear-gradient(45deg, #4CAF50, #45a049); 
                            color: white; 
                            border-radius: 50%; 
                            width: 40px; 
                            height: 40px; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            border: 3px solid white; 
                            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                            animation: pulse 2s infinite;
                            font-size: 18px;
                        ">üìç
                        </div>
                        <style>
                        @keyframes pulse {
                            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                            50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6); }
                            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                        }
                        </style>`,
                        className: 'current-location-icon',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                }).addTo(map);

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                currentLocationMarker.bindPopup(`
                    <div style="text-align: center; font-weight: bold;">
                        <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                        <div style="font-size: 12px; color: #666;">
                            –®–∏—Ä–æ—Ç–∞: ${currentUserLocation.lat.toFixed(6)}<br>
                            –î–æ–ª–≥–æ—Ç–∞: ${currentUserLocation.lng.toFixed(6)}
                        </div>
                    </div>
                `);

                console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω');
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', selectedLocationMarker ? '–ï—Å—Ç—å' : '–ù–ï–¢!');

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.textContent = '‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ';
                button.disabled = false;
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);

                // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è - –ù–ï –£–î–ê–õ–Ø–ï–ú –µ–≥–æ!
                if (selectedLocation && selectedLocationMarker) {
                    console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞');
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Ç–∞–∫ —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞
                    const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                    
                    // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                    calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                    
                    if (window.destinationData) {
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ. –ú–∞—Ä—à—Ä—É—Ç –∫ –º–µ—Å—Ç—É ${window.destinationData.name} –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω.`);
                    } else {
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ. –ú–∞—Ä—à—Ä—É—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—Ç—É –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω.`);
                    }
                } else {
                    // –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    map.setView([currentUserLocation.lat, currentUserLocation.lng], 15);
                    speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ. –®–∏—Ä–æ—Ç–∞ ${currentUserLocation.lat.toFixed(3)}, –¥–æ–ª–≥–æ—Ç–∞ ${currentUserLocation.lng.toFixed(3)}. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.`);
                }
                
                document.getElementById('statusText').textContent = '–ì–æ—Ç–æ–≤ –∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!';
            },
            function(error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏:', error);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.textContent = originalText;
                button.disabled = false;
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GPS –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                        break;
                    default:
                        errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                        break;
                }
                speakText(errorMessage);
                document.getElementById('statusText').textContent = errorMessage;
                console.log('üîÑ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑');
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
                maximumAge: 30000  // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –∫—ç—à–∞
            }
        );
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ (—ç–º—É–ª—è—Ü–∏—è)
    function calculateAndDisplayRoute(origin, destination) {
        console.log('üõ£Ô∏è –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –æ—Ç', origin, '–¥–æ', destination);
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }
        
        // –°–æ–∑–¥–∞–µ–º —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        const route = generateEmulatedRoute(origin, destination);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        const latlngs = route.path.map(point => [point.lat, point.lng]);
        routePolyline = L.polyline(latlngs, {
            color: '#FF0000',
            weight: 4,
            opacity: 0.8
        }).addTo(map);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
        map.fitBounds(routePolyline.getBounds());
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
        document.getElementById('routeInfo').classList.remove('hidden');
        document.getElementById('routeDetails').innerHTML = `
            <div style="color: white; text-align: left;">
                <p><strong>üö∂ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${route.legs[0].distance.text}</p>
                <p><strong>‚è±Ô∏è –í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> ${route.legs[0].duration.text}</p>
                <p><strong>üìç –û—Ç:</strong> ${route.legs[0].start_address}</p>
                <p><strong>üéØ –î–æ:</strong> ${route.legs[0].end_address}</p>
            </div>
        `;

        speakText(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${route.legs[0].distance.text}, –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏ ${route.legs[0].duration.text}`);
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    function generateEmulatedRoute(origin, destination) {
        const startLat = origin.lat;
        const startLng = origin.lng;
        const endLat = destination.lat;
        const endLng = destination.lng;
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—Ä–µ–º—è
        const distance = calculateDistance(startLat, startLng, endLat, endLng);
        const distanceMeters = Math.round(distance * 1000);
        const durationMinutes = Math.round(distanceMeters / 80); // ~5 –∫–º/—á –ø–µ—à–∫–æ–º
        
        // –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        const path = generateWalkingPath(startLat, startLng, endLat, endLng);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å–∞
        const startAddress = generateAlmatyAddress(startLat, startLng);
        const endAddress = generateAlmatyAddress(endLat, endLng);
        
        return {
            path: path,
            legs: [{
                distance: {
                    text: distanceMeters < 1000 ? `${distanceMeters} –º` : `${(distance).toFixed(1)} –∫–º`,
                    value: distanceMeters
                },
                duration: {
                    text: durationMinutes < 60 ? `${durationMinutes} –º–∏–Ω` : `${Math.floor(durationMinutes/60)} —á ${durationMinutes%60} –º–∏–Ω`,
                    value: durationMinutes * 60
                },
                start_address: startAddress,
                end_address: endAddress
            }]
        };
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –ø–µ—à–µ—Ö–æ–¥–Ω–æ–≥–æ –ø—É—Ç–∏
    function generateWalkingPath(startLat, startLng, endLat, endLng) {
        const path = [];
        const steps = 8; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        const randomFactor = 0.001; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        
        for (let i = 0; i <= steps; i++) {
            const ratio = i / steps;
            
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–ª—É—á–∞–π–Ω—ã–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º
            const lat = startLat + (endLat - startLat) * ratio + (Math.random() - 0.5) * randomFactor;
            const lng = startLng + (endLng - startLng) * ratio + (Math.random() - 0.5) * randomFactor;
            
            path.push({ lat: lat, lng: lng });
        }
        
        return path;
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –ê–ª–º–∞—Ç—ã
    function generateAlmatyAddress(lat, lng) {
        const almatyStreets = [
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –ê–±–∞—è', '—É–ª–∏—Ü–∞ –°–∞—Ç–ø–∞–µ–≤–∞', '–ø—Ä–æ—Å–ø–µ–∫—Ç –ê–ª—å-–§–∞—Ä–∞–±–∏',
            '—É–ª–∏—Ü–∞ –¢–æ–ª–µ –±–∏', '–ø—Ä–æ—Å–ø–µ–∫—Ç –ù–∞–∑–∞—Ä–±–∞–µ–≤–∞', '—É–ª–∏—Ü–∞ –ñ–∏–±–µ–∫ –ñ–æ–ª—ã',
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –î–æ—Å—Ç—ã–∫', '—É–ª–∏—Ü–∞ –ú–∞–Ω–∞—Å–∞', '—É–ª–∏—Ü–∞ –ë–æ–≥–µ–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞',
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –†–∞–π—ã–º–±–µ–∫–∞', '—É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–≥–∞–∑—ã', '—É–ª–∏—Ü–∞ –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞'
        ];
        
        // –í—ã–±–∏—Ä–∞–µ–º —É–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
        const streetIndex = Math.floor((lat + lng) * 1000) % almatyStreets.length;
        const street = almatyStreets[streetIndex];
        const houseNumber = Math.floor((lat + lng) * 10000) % 200 + 1;
        
        return `${street}, ${houseNumber}, –ê–ª–º–∞—Ç—ã`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
    function saveCurrentLocationOnMap() {
        if (!selectedLocation) {
            speakText('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
            return;
        }
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('locationName').focus();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏
    function saveSelectedLocation() {
        const name = document.getElementById('locationName').value.trim();
        const description = document.getElementById('locationDescription').value.trim();
        const category = document.getElementById('locationCategory').value;

        if (!name) {
            speakText('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
            document.getElementById('locationName').focus();
            return;
        }

        if (!selectedLocation) {
            speakText('–ú–µ—Å—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
            return;
        }

        const locationData = {
            location: selectedLocation,
            name: name,
            description: description,
            category: category
        };

        fetch('/save_location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                speakText(`–ú–µ—Å—Ç–æ ${name} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                
                // –ù–û–í–û–ï: –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–µ—Å—Ç–∞
                const newLocation = data.location_data;
                createPermanentLocationMarker(newLocation);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
                savedLocations.push(newLocation);
                
                clearSelection();
                loadSavedLocations(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–æ–π
                showNotification(`–ú–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞: ${data.static_url}`, 'success');
                
                console.log('‚úÖ –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ:', newLocation.name);
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            speakText('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Å—Ç–∞');
        });
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
    function clearSelection() {
        selectedLocation = null;
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        document.getElementById('selectedLocationInfo').classList.add('hidden');
        document.getElementById('saveLocationBtn').disabled = true;
        document.getElementById('locationName').value = '';
        document.getElementById('locationDescription').value = '';
        document.getElementById('locationCategory').value = 'general';
    }

    // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã
    function clearMap() {
        // –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ - –ù–ï —É–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        if (window.destinationData) {
            console.log('üö´ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ - –º–∞—Ä–∫–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è');
            speakText('–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω–æ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏');
            
            // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            document.getElementById('routeInfo').classList.add('hidden');
            return;
        }
        
        // –û–±—ã—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
        }
        document.getElementById('routeInfo').classList.add('hidden');
        clearSelection();
        speakText('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç
    async function loadSavedLocations() {
        try {
            const response = await fetch('/list_saved_locations');
            const data = await response.json();
            
            if (data.success && data.locations.length > 0) {
                savedLocations = data.locations;
                displaySavedLocations();
                
                // –ù–û–í–û–ï: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –∫–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                if (map) {
                    displaySavedLocationsOnMap();
                }
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${savedLocations.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ`);
            } else {
                document.getElementById('savedLocationsList').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: white; padding: 40px;">
                        <p>üó∫Ô∏è –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç</p>
                        <p style="opacity: 0.7;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç:', error);
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç
    function displaySavedLocations() {
        const container = document.getElementById('savedLocationsList');
        container.innerHTML = savedLocations.map(location => `
            <div class="saved-location-card" onclick="selectSavedLocation('${location.id}')">
                <h4>${getCategoryIcon(location.category)} ${location.name}</h4>
                <p>${location.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                <p style="font-size: 0.8em; opacity: 0.7;">
                    üíæ ${formatDate(location.timestamp)} | üëÅÔ∏è ${location.access_count}
                </p>
                <div class="location-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); navigateToSavedLocation('${location.id}')">
                        üß≠ 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); showOnMap('${location.id}')">
                        üó∫Ô∏è 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); copyLocationLink('${location.id}')">
                        üîó 
                    </button>
                </div>
            </div>
        `).join('');
    }

    // –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
    function selectSavedLocation(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            selectedLocation = { lat: location.lat, lng: location.lng };
            selectLocationOnMap({ lat: location.lat, lng: location.lng });
            map.setView([location.lat, location.lng], 16);
            speakText(`–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç–æ ${location.name}`);
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ
    function showOnMap(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞
            const marker = findSavedLocationMarker(locationId);
            
            if (marker) {
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
                map.setView([location.lat, location.lng], 17);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º popup –º–∞—Ä–∫–µ—Ä–∞
                marker.openPopup();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.style.animation = 'bounce 1s ease-in-out 3';
                }
                
                speakText(`–ü–æ–∫–∞–∑—ã–≤–∞—é –º–µ—Å—Ç–æ ${location.name} –Ω–∞ –∫–∞—Ä—Ç–µ`);
                console.log('‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ:', location.name);
            } else {
                console.warn('‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π');
                // Fallback - —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                createPermanentLocationMarker(location);
                map.setView([location.lat, location.lng], 17);
                speakText(`–ü–æ–∫–∞–∑—ã–≤–∞—é –º–µ—Å—Ç–æ ${location.name} –Ω–∞ –∫–∞—Ä—Ç–µ`);
            }
        }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É –º–µ—Å—Ç—É
    function navigateToSavedLocation(locationId) {
        window.location.href = `/location/${locationId}`;
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    function copyLocationLink(locationId) {
        const link = `${window.location.origin}/location/${locationId}`;
        navigator.clipboard.writeText(link).then(() => {
            speakText('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            speakText('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏');
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
    function startAutoNavigation() {
        console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –ü–û–õ–ù–û–°–¢–¨–Æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é');
        
        if (!window.destinationData) {
            console.error('‚ùå –î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!');
            return;
        }
        
        // –í–ò–ó–£–ê–õ–¨–ù–´–ô –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        document.getElementById('statusText').textContent = 'ü§ñ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ï–ñ–ò–ú: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...';
        document.getElementById('statusText').style.cssText = `
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            animation: autoProcessPulse 2s infinite;
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        if (!document.getElementById('autoProcessStyles')) {
            const style = document.createElement('style');
            style.id = 'autoProcessStyles';
            style.textContent = `
                @keyframes autoProcessPulse {
                    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
                    50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
                    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ–±—ä—è–≤–ª—è–µ–º –æ –Ω–∞—á–∞–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        speakText(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –ù–∞—á–∏–Ω–∞—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –∫–æ–º–ø–∞—Å–∞, –∑–∞—Ç–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞. –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.`);
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞
        if (map) {
            createDestinationMarker();
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–º –≤—Å–µ —ç—Ç–∞–ø—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
        setTimeout(() => {
            autoCompassCalibration();
        }, 2000); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞ (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function autoCompassCalibration() {
        console.log('üß≠ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞...');
        speakText('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–æ–º–ø–∞—Å');
        
        // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ—Ç
        document.getElementById('statusText').textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞...';
        document.getElementById('calibrateBtn').disabled = true;
        document.getElementById('calibrateBtn').textContent = '‚è≥ –ê–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞...';

        // –≠–º—É–ª—è—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        fetch('/calibrate_compass', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'auto_calibrate' })
        })
        .then(response => response.json())
        .then(data => {
            isCompassCalibrated = true;
            document.getElementById('statusText').textContent = '–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!';
            document.getElementById('calibrateBtn').textContent = '‚úÖ –ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            speakText('–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                autoCaptureView();
            }, 1500);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:', error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            isCompassCalibrated = true;
            document.getElementById('calibrateBtn').textContent = '‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ';
            speakText('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞. –û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.');
            setTimeout(() => {
                autoCaptureView();
            }, 1000);
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function autoCaptureView() {
        console.log('üì∏ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');
        speakText('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞ —Å –ø–æ–º–æ—â—å—é –∫–∞–º–µ—Ä—ã');
        
        document.getElementById('statusText').textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...';
        document.getElementById('captureBtn').disabled = true;
        document.getElementById('captureBtn').textContent = '‚è≥ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';

        // –≠–º—É–ª—è—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        fetch('/capture_view', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'auto_capture' })
        })
        .then(response => response.json())
        .then(data => {
            isDirectionCaptured = true;
            document.getElementById('statusText').textContent = '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!';
            document.getElementById('captureBtn').textContent = '‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
            console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            speakText('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ. –ü–æ–ª—É—á–∞—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
            setTimeout(() => {
                autoGetLocationAndRoute();
            }, 1500);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:', error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            isDirectionCaptured = true;
            document.getElementById('captureBtn').textContent = '‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ';
            speakText('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–æ. –ü–æ–ª—É—á–∞—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.');
            setTimeout(() => {
                autoGetLocationAndRoute();
            }, 1000);
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
    function autoGetLocationAndRoute() {
        console.log('üìç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
        speakText('–ü–æ–ª—É—á–∞—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
        
        document.getElementById('statusText').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }

                    currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: linear-gradient(45deg, #4CAF50, #45a049); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 3px solid white; 
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                font-size: 18px;
                            ">üìç</div>`,
                            className: 'current-location-icon',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(map);

                    currentLocationMarker.bindPopup(`
                        <div style="text-align: center; font-weight: bold;">
                            <div style="font-size: 16px; color: #4CAF50;">üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                        </div>
                    `);

                    console.log('‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ, —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç');
                    speakText(`–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ. –°—Ç—Ä–æ—é –º–∞—Ä—à—Ä—É—Ç –∫ –º–µ—Å—Ç—É ${window.destinationData.name}`);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                    if (selectedLocationMarker) {
                        const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                    setTimeout(() => {
                        autoCalculateRoute();
                    }, 1500);
                },
                function(error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                    speakText('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ê–ª–º–∞—Ç—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞.');
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –ê–ª–º–∞—Ç—ã –∫–∞–∫ fallback
                    currentUserLocation = { lat: 43.238293, lng: 76.889709 };
                    
                    setTimeout(() => {
                        autoCalculateRoute();
                    }, 1000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 30000
                }
            );
        } else {
            speakText('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É—é —Ü–µ–Ω—Ç—Ä –ê–ª–º–∞—Ç—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.');
            currentUserLocation = { lat: 43.238293, lng: 76.889709 };
            setTimeout(() => {
                autoCalculateRoute();
            }, 1000);
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
    function autoCalculateRoute() {
        console.log('üõ£Ô∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...');
        speakText('–°—Ç—Ä–æ—é –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–µ—à–µ—Ö–æ–¥–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç');
        
        document.getElementById('statusText').textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...';

        if (!currentUserLocation || !selectedLocation) {
            console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞');
            speakText('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
            return;
        }

        // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
        
        setTimeout(() => {
            console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é');
            document.getElementById('statusText').textContent = '–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! –ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é';
            speakText(`–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω! –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –°–ª–µ–¥—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —É–∫–∞–∑–∞–Ω–∏—è–º.`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            setTimeout(() => {
                autoStartNavigation();
            }, 2000);
        }, 1000);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function autoStartNavigation() {
        console.log('üß≠ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –∑–∞–ø—É—Å–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏...');
        
        if (!currentUserLocation || !selectedLocation) {
            speakText('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
            return;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        startNavigation();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –≤—Å–µ –≥–æ—Ç–æ–≤–æ
        document.getElementById('statusText').textContent = 'üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞!';
        
        speakText(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∫ –º–µ—Å—Ç—É ${window.destinationData.name} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞! –Ø –±—É–¥—É —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –≤–∞—Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.`);
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getCategoryIcon(category) {
        const icons = {
            'general': 'üìç', 'home': 'üè†', 'work': 'üè¢', 'shop': 'üõí',
            'medical': 'üè•', 'education': 'üéì', 'transport': 'üöå',
            'food': 'üçΩÔ∏è', 'entertainment': 'üé¨'
        };
        return icons[category] || 'üìç';
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // –ù–∞—á–∞–ª–æ –≥–æ–ª–æ—Å–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function startNavigation() {
        if (!currentUserLocation || !selectedLocation) {
            speakText('–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
            return;
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const distance = calculateDistance(
            currentUserLocation.lat, currentUserLocation.lng, 
            selectedLocation.lat, selectedLocation.lng
        );
        
        const bearing = calculateBearing(
            currentUserLocation.lat, currentUserLocation.lng,
            selectedLocation.lat, selectedLocation.lng
        );
        
        const direction = getDirectionFromBearing(bearing);
        const distanceText = distance < 1 ? `${Math.round(distance * 1000)} –º–µ—Ç—Ä–æ–≤` : `${distance.toFixed(1)} –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤`;
        
        if (window.destinationData) {
            // –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            speakText(`–ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏: ${distanceText}. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}. –ò–¥–∏—Ç–µ –ø—Ä—è–º–æ, —è –±—É–¥—É –≤–∞—Å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–∞–∂–∏—Ç–µ "–ì–¥–µ —è" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.`);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            startPeriodicNavigation();
        } else {
            speakText(`–ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceText}, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}. –°–ª–µ–¥—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —É–∫–∞–∑–∞–Ω–∏—è–º.`);
        }
    }

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
    function startPeriodicNavigation() {
        const navigationInterval = setInterval(() => {
            if (!currentUserLocation || !selectedLocation) {
                clearInterval(navigationInterval);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    const distance = calculateDistance(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    // –ï—Å–ª–∏ –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–≤ —Ä–∞–¥–∏—É—Å–µ 50 –º–µ—Ç—Ä–æ–≤)
                    if (distance < 0.05) {
                        clearInterval(navigationInterval);
                        speakText(`–í—ã –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${window.destinationData ? window.destinationData.name : '–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ'}. –ù–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`);
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const bearing = calculateBearing(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    const direction = getDirectionFromBearing(bearing);
                    const distanceText = distance < 1 ? `${Math.round(distance * 1000)} –º–µ—Ç—Ä–æ–≤` : `${distance.toFixed(1)} –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤`;
                    
                    speakText(`–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ. –î–æ —Ü–µ–ª–∏: ${distanceText}. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}.`);
                },
                (error) => {
                    console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 10000 }
            );
        }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    }

    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –∞–∑–∏–º—É—Ç—É
    function calculateBearing(lat1, lng1, lat2, lng2) {
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const lat1Rad = lat1 * Math.PI / 180;
        const lat2Rad = lat2 * Math.PI / 180;
        
        const y = Math.sin(dLng) * Math.cos(lat2Rad);
        const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                  Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
        
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞ –≤ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function getDirectionFromBearing(bearing) {
        const directions = [
            '—Å–µ–≤–µ—Ä', '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫', '–≤–æ—Å—Ç–æ–∫', '—é–≥–æ-–≤–æ—Å—Ç–æ–∫',
            '—é–≥', '—é–≥–æ-–∑–∞–ø–∞–¥', '–∑–∞–ø–∞–¥', '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥'
        ];
        
        const index = Math.round(bearing / 45) % 8;
        return `–Ω–∞ ${directions[index]}`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
        console.log('üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ window.destinationData:', window.destinationData);
        
        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
        function tryInitialize() {
            console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
            console.log('üìö Leaflet –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof L !== 'undefined');
            
            if (typeof L !== 'undefined') {
                console.log('‚úÖ Leaflet –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞—é initMaps');
                initMaps();
                return true;
            }
            return false;
        }
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
        if (!tryInitialize()) {
            console.log('‚è≥ Leaflet –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º...');
            
            // –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 500–º—Å
            setTimeout(() => {
                if (!tryInitialize()) {
                    console.log('‚è≥ –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 1—Å...');
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 1—Å
                    setTimeout(() => {
                        if (!tryInitialize()) {
                            console.log('‚è≥ –¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 2—Å...');
                            
                            // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 2—Å
                            setTimeout(() => {
                                if (!tryInitialize()) {
                                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Leaflet');
                                    speakText('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                                    document.getElementById('statusText').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                                }
                            }, 2000);
                        }
                    }, 1000);
                }
            }, 500);
        }
        
        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
        if (window.destinationData) {
            console.log('üéØ –°–¢–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–°–´–õ–ö–ê - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
            let checkCount = 0;
            const maxChecks = 10;
            
            const staticLinkChecker = setInterval(() => {
                checkCount++;
                console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ${checkCount}/${maxChecks} –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏`);
                
                if (checkCount >= maxChecks) {
                    clearInterval(staticLinkChecker);
                    console.log('‚èπÔ∏è –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏');
                    return;
                }
                
                // –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω
                if (window.destinationData && !isCompassCalibrated) {
                    console.log('üöÄ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
                    if (typeof startAutoNavigation === 'function') {
                        startAutoNavigation();
                    } else {
                        console.error('‚ùå –§—É–Ω–∫—Ü–∏—è startAutoNavigation –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                    }
                }
                
                // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–Ω
                if (window.destinationData && !selectedLocationMarker && typeof createDestinationMarker === 'function') {
                    console.log('üéØ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞');
                    createDestinationMarker();
                }
            }, 3000);
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .permanent-location-marker {
            transition: all 0.3s ease;
        }
        
        .permanent-location-marker:hover {
            transform: scale(1.1);
            z-index: 1001 !important;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }
        
        .leaflet-popup-tip {
            background: white;
        }
    `;
    document.head.appendChild(style);

    // –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è - –ø—Ä—è–º–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –±–µ–∑ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (–¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫)
    function startDirectNavigation() {
        console.log('üéØ –ü–†–Ø–ú–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø - –ø—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
        
        if (!window.destinationData) {
            console.error('‚ùå –î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!');
            return;
        }
        
        // –ü—Ä–æ—Å—Ç–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
        speakText(`–ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –ü–æ–ª—É—á–∞—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.`);
        
        // –°—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –∏ –¥–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        setTimeout(() => {
            getLocationAndGiveSimpleDirections();
        }, 2000);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –ø—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    function getLocationAndGiveSimpleDirections() {
        console.log('üìç –ü–æ–ª—É—á–∞—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π');
        
        document.getElementById('statusText').textContent = '–û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }

                    currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: linear-gradient(45deg, #4CAF50, #45a049); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 3px solid white; 
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                font-size: 18px;
                            ">üìç</div>`,
                            className: 'current-location-icon',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(map);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                    if (selectedLocationMarker) {
                        const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                        
                        // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                    }

                    // –ü–†–û–°–¢–´–ï –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    setTimeout(() => {
                        giveSimpleVoiceDirections();
                    }, 1500);
                },
                function(error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                    // –î–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–∞–∂–µ –±–µ–∑ —Ç–æ—á–Ω–æ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                    speakText('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –î–∞—é –æ–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.');
                    setTimeout(() => {
                        giveSimpleVoiceDirections();
                    }, 2000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 30000
                }
            );
        } else {
            // –î–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –±–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
            setTimeout(() => {
                giveSimpleVoiceDirections();
            }, 1000);
        }
    }

    // –ü—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function giveSimpleVoiceDirections() {
        console.log('üó£Ô∏è –î–∞—é –ø—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
        
        document.getElementById('statusText').textContent = 'üéØ –ì–æ–ª–æ—Å–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞!';
        document.getElementById('statusText').style.cssText = `
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        `;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        const simpleDirections = [
            "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ –∏ –∏–¥–∏—Ç–µ –ø—Ä—è–º–æ 100 –º–µ—Ç—Ä–æ–≤",
            "–ò–¥–∏—Ç–µ –ø—Ä—è–º–æ 150 –º–µ—Ç—Ä–æ–≤, –∑–∞—Ç–µ–º –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ", 
            "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ –∏ –ø—Ä–æ–π–¥–∏—Ç–µ 80 –º–µ—Ç—Ä–æ–≤ –ø—Ä—è–º–æ",
            "–ò–¥–∏—Ç–µ –ø—Ä—è–º–æ 200 –º–µ—Ç—Ä–æ–≤ –¥–æ –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
            "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ, –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑ 50 –º–µ—Ç—Ä–æ–≤ –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ",
            "–ü—Ä–æ–π–¥–∏—Ç–µ –ø—Ä—è–º–æ 120 –º–µ—Ç—Ä–æ–≤, –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥–µ—Ç —Å–ª–µ–≤–∞"
        ];
        
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        const randomDirection = simpleDirections[Math.floor(Math.random() * simpleDirections.length)];
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –≥–æ–ª–æ—Å–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
        speakText(`–ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. ${randomDirection}. –°–ª–µ–¥—É–π—Ç–µ —ç—Ç–∏–º —É–∫–∞–∑–∞–Ω–∏—è–º.`);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            const followUpDirections = [
                "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä—è–º–æ",
                "–í—ã –¥–≤–∏–∂–µ—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏", 
                "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ",
                "–ò–¥–∏—Ç–µ –ø—Ä—è–º–æ, –≤—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏",
                "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ —á–µ—Ä–µ–∑ 50 –º–µ—Ç—Ä–æ–≤"
            ];
            
            const followUp = followUpDirections[Math.floor(Math.random() * followUpDirections.length)];
            speakText(followUp);
        }, 15000);
        
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            speakText(`–í—ã –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç–µ—Å—å –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –ò—â–∏—Ç–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –∏–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã.`);
        }, 30000);
        
        // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–±—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ 45 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            speakText(`–í—ã –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${window.destinationData.name}. –ù–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`);
            
            document.getElementById('statusText').textContent = 'üéâ –í—ã –ø—Ä–∏–±—ã–ª–∏!';
            document.getElementById('statusText').style.cssText = `
                background: linear-gradient(45deg, #4CAF50, #45a049);
                color: white;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
                font-weight: bold;
            `;
        }, 45000);
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
    function createPermanentLocationMarker(location) {
        console.log('üè† –°–æ–∑–¥–∞—é –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è:', location.name);
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categoryIcon = getCategoryIcon(location.category);
        const categoryColor = getCategoryColor(location.category);
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        const marker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                html: `<div style="
                    background: ${categoryColor}; 
                    color: white; 
                    border-radius: 50%; 
                    width: 35px; 
                    height: 35px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    border: 3px solid white; 
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    font-size: 16px;
                    font-weight: bold;
                    z-index: 1000;
                ">${categoryIcon}</div>`,
                className: 'permanent-location-marker',
                iconSize: [35, 35],
                iconAnchor: [17, 17]
            })
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π popup
        const popupContent = `
            <div style="min-width: 200px; text-align: center;">
                <div style="font-size: 18px; font-weight: bold; color: ${categoryColor}; margin-bottom: 8px;">
                    ${categoryIcon} ${location.name}
                </div>
                <div style="color: #666; margin-bottom: 8px; font-size: 14px;">
                    ${location.description || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ'}
                </div>
                <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                    üìç ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}
                </div>
                <div style="font-size: 11px; color: #999; margin-bottom: 10px;">
                    üíæ ${formatDate(location.timestamp)} | üëÅÔ∏è ${location.access_count}
                </div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button onclick="navigateToSavedLocation('${location.id}')" 
                            style="background: #4CAF50; color: white; border: none; border-radius: 15px; padding: 6px 12px; cursor: pointer; font-size: 12px;">
                        üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è
                    </button>
                    <button onclick="copyLocationLink('${location.id}')" 
                            style="background: #2196F3; color: white; border: none; border-radius: 15px; padding: 6px 12px; cursor: pointer; font-size: 12px;">
                        üîó –°—Å—ã–ª–∫–∞
                    </button>
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É
        marker.addTo(map);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–∞—Ä–∫–µ—Ä
        marker.locationId = location.id;
        savedLocationMarkers.push(marker);
        
        console.log('‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–Ω –¥–ª—è:', location.name);
        return marker;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function getCategoryColor(category) {
        const colors = {
            'general': '#9C27B0',     // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
            'home': '#4CAF50',        // –ó–µ–ª–µ–Ω—ã–π
            'work': '#FF9800',        // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            'shop': '#2196F3',        // –°–∏–Ω–∏–π
            'medical': '#F44336',     // –ö—Ä–∞—Å–Ω—ã–π
            'education': '#795548',   // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π
            'transport': '#607D8B',   // –°–µ—Ä–æ-—Å–∏–Ω–∏–π
            'food': '#FF5722',        // –ö—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
            'entertainment': '#E91E63' // –†–æ–∑–æ–≤—ã–π
        };
        return colors[category] || colors['general'];
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
    function displaySavedLocationsOnMap() {
        console.log('üó∫Ô∏è –û—Ç–æ–±—Ä–∞–∂–∞—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ:', savedLocations.length);
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        clearSavedLocationMarkers();
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
        savedLocations.forEach(location => {
            createPermanentLocationMarker(location);
        });
        
        speakText(`–ù–∞ –∫–∞—Ä—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${savedLocations.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç`);
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
    function clearSavedLocationMarkers() {
        savedLocationMarkers.forEach(marker => {
            if (map.hasLayer(marker)) {
                map.removeLayer(marker);
            }
        });
        savedLocationMarkers = [];
    }
    
    // –ü–æ–∏—Å–∫ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ ID –ª–æ–∫–∞—Ü–∏–∏
    function findSavedLocationMarker(locationId) {
        return savedLocationMarkers.find(marker => marker.locationId === locationId);
    }
</script>
{% endblock %}