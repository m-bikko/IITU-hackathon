<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAla - –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    
    <!-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ª–µ–ø—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <meta name="description" content="–£–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–ª–µ–ø—ã—Ö –ª—é–¥–µ–π —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º">
    
    <!-- OpenStreetMap Leaflet –¥–ª—è –∫–∞—Ä—Ç (–±–µ–∑ API –∫–ª—é—á–µ–π) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
            font-size: 18px;
            line-height: 1.6;
            padding: 20px;
        }
        
        /* –í—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç –¥–ª—è —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏—Ö */
        .high-contrast {
            background: #000;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .main-header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-header p {
            font-size: 1.3em;
            opacity: 0.9;
        }
        
        .nav-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .nav-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .nav-card:hover, .nav-card:focus {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            border-color: #fff;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .nav-card .icon {
            font-size: 4em;
            margin-bottom: 15px;
            display: block;
        }
        
        .nav-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .nav-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 150px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.4);
        }
        
        .btn-large {
            padding: 20px 40px;
            font-size: 1.3em;
            min-width: 200px;
        }
        
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .global-voice-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .global-voice-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .global-voice-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
        }
        
        .global-voice-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .global-voice-btn.listening {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            animation: pulse-listening 1.5s infinite;
        }
        
        .global-voice-btn.listening::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border-radius: 50%;
            opacity: 0.3;
            animation: wave 2s infinite;
        }
        
        @keyframes pulse-listening {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wave {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .microphone-status {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease;
        }
        
        .microphone-status.error {
            background: rgba(255, 107, 107, 0.95);
            color: white;
        }
        
        .microphone-status.success {
            background: rgba(76, 175, 80, 0.95);
            color: white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .voice-instructions {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .instruction-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            text-align: center;
            animation: modalAppear 0.3s ease;
        }
        
        .instruction-content h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .instruction-content ul {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .instruction-content li {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        @keyframes modalAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                padding: 10px;
            }
            
            .main-header h1 {
                font-size: 2em;
            }
            
            .nav-cards {
                grid-template-columns: 1fr;
            }
            
            .nav-card {
                padding: 20px;
            }
            
            .nav-card .icon {
                font-size: 3em;
            }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .map-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .compass-indicator {
            width: 100px;
            height: 100px;
            border: 3px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            position: relative;
        }
        
        .compass-needle {
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom, #ff6b6b, #fff);
            position: absolute;
            transform-origin: center bottom;
            transition: transform 0.5s ease;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1001;
            display: none;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .notification.show {
            display: block;
            animation: slideInDown 0.3s ease;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateX(-50%) translateY(-100%);
            }
            to {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* –°—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ */
        .voice-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            z-index: 1000;
            display: none;
        }
        
        .voice-status.show {
            display: block;
        }
        
        /* –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* –§–æ–∫—É—Å –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .focusable:focus {
            outline: 3px solid #ffff00;
            outline-offset: 2px;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .global-voice-panel {
                bottom: 20px;
                right: 20px;
            }
            
            .global-voice-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8em;
            }
            
            .microphone-status {
                font-size: 0.8em;
                padding: 6px 12px;
            }
            
            .instruction-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
    
    
</head>
<body>
    <!-- –ì–æ–ª–æ—Å–æ–≤–æ–π —Å—Ç–∞—Ç—É—Å -->
    <div class="voice-status" id="voiceStatus">
        <span id="voiceStatusText">–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤</span>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
    <div class="container">
        
<div class="navigation-container">
    <header class="nav-header">
        <h1>üß≠ –£–º–Ω–∞—è –ù–∞–≤–∏–≥–∞—Ü–∏—è</h1>
        <p id="statusText">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞—Å–∞</p>
    </header>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="control-panel">
        <div class="control-group">
            <button id="calibrateBtn" class="control-btn primary" onclick="startCompassCalibration()">
                üß≠ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–ø–∞—Å
            </button>
            <button id="captureBtn" class="control-btn secondary" onclick="captureView()" disabled>
                üì∏ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </button>
            <button id="getCurrentLocationBtn" class="control-btn" onclick="getCurrentLocation()">
                üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            </button>
        </div>
        
        <div class="control-group">
            <button id="saveLocationBtn" class="control-btn success" onclick="saveCurrentLocationOnMap()" disabled>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ
            </button>
            <button id="clearMapBtn" class="control-btn warning" onclick="clearMap()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É
            </button>
        </div>
    </div>

    <!-- Google Maps –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="map-container">
        <div id="map" class="leaflet-map"></div>
        <div class="map-controls">
            <div class="map-info">
                <div id="selectedLocationInfo" class="location-info hidden">
                    <h4>üìç –í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ</h4>
                    <p id="selectedCoords">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å</p>
                    <input type="text" id="locationName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞..." class="location-input">
                    <textarea id="locationDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." class="location-input"></textarea>
                    <select id="locationCategory" class="location-input">
                        <option value="general">–û–±—â–µ–µ</option>
                        <option value="home">–î–æ–º</option>
                        <option value="work">–†–∞–±–æ—Ç–∞</option>
                        <option value="shop">–ú–∞–≥–∞–∑–∏–Ω</option>
                        <option value="medical">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
                        <option value="education">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                        <option value="transport">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                        <option value="food">–ï–¥–∞</option>
                        <option value="entertainment">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                    </select>
                    <button onclick="saveSelectedLocation()" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</button>
                    <button onclick="clearSelection()" class="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ -->
    <div class="saved-locations-section">
        <h3>üìç –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞</h3>
        <div id="savedLocationsList" class="saved-locations-grid">
            <!-- –ú–µ—Å—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –ú–∞—Ä—à—Ä—É—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div id="routeInfo" class="route-info hidden">
        <h3>üõ£Ô∏è –ú–∞—Ä—à—Ä—É—Ç</h3>
        <div id="routeDetails"></div>
        <button onclick="startNavigation()" class="nav-btn">üß≠ –ù–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é</button>
    </div>
</div>

<!-- Destination data for auto-navigation -->

<script>
    window.destinationData = {&#34;name&#34;: &#34;\u0426\u0435\u043d\u0442\u0440 \u0410\u043b\u043c\u0430\u0442\u044b&#34;, &#34;description&#34;: &#34;\u041f\u043b\u043e\u0449\u0430\u0434\u044c \u0420\u0435\u0441\u043f\u0443\u0431\u043b\u0438\u043a\u0438 \u0432 \u0446\u0435\u043d\u0442\u0440\u0435 \u0433\u043e\u0440\u043e\u0434\u0430&#34;, &#34;latitude&#34;: 43.238293, &#34;longitude&#34;: 76.889709, &#34;category&#34;: &#34;general&#34;, &#34;id&#34;: &#34;47657cc3&#34;, &#34;auto_navigation&#34;: true, &#34;creation_time&#34;: &#34;2025-06-28T03:38:56.537758&#34;};
</script>


<style>
    .navigation-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .nav-header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }

    .nav-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: white;
    }

    .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .control-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 15px 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        min-width: 160px;
    }

    .control-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .control-btn:disabled {
        background: linear-gradient(45deg, #9e9e9e, #757575);
        cursor: not-allowed;
        opacity: 0.6;
    }

    .control-btn.primary {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .control-btn.primary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .control-btn.secondary {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .control-btn.secondary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }

    .control-btn.success {
        background: linear-gradient(45deg, #FF9800, #F57C00);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .control-btn.success:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
    }

    .control-btn.warning {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .control-btn.warning:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }

    .map-container {
        position: relative;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        overflow: hidden;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .leaflet-map {
        width: 100%;
        height: 600px;
        border-radius: 20px;
    }

    .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        pointer-events: none;
        z-index: 1000;
    }

    .map-info {
        pointer-events: auto;
    }

    .location-info {
        background: rgba(255,255,255,0.95);
        color: #333;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        backdrop-filter: blur(10px);
        max-width: 350px;
    }

    .location-info h4 {
        margin: 0 0 15px 0;
        font-size: 1.3em;
        color: #2c3e50;
    }

    .location-input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .location-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .save-btn, .cancel-btn, .nav-btn {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
    }

    .cancel-btn {
        background: linear-gradient(45deg, #f44336, #d32f2f);
    }

    .nav-btn {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        font-size: 1.2em;
        padding: 15px 30px;
    }

    .save-btn:hover, .cancel-btn:hover, .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .saved-locations-section {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
    }

    .saved-locations-section h3 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8em;
        color: white;
    }

    .saved-locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    .saved-location-card {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .saved-location-card:hover {
        transform: translateY(-3px);
        background: rgba(255,255,255,0.2);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .saved-location-card h4 {
        margin: 0 0 10px 0;
        color: white;
        font-size: 1.3em;
    }

    .saved-location-card p {
        margin: 0 0 10px 0;
        color: rgba(255,255,255,0.8);
        font-size: 0.9em;
    }

    .location-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.05);
    }

    .route-info {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        text-align: center;
    }

    .route-info h3 {
        margin-bottom: 20px;
        color: white;
        font-size: 1.8em;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .control-group {
            justify-content: center;
        }
        
        .control-btn {
            min-width: 140px;
            padding: 12px 20px;
            font-size: 1em;
        }
        
        .leaflet-map {
            height: 400px;
        }
        
        .location-info {
            max-width: 280px;
        }
    }
</style>

<script>
    let map;
    let currentLocationMarker;
    let selectedLocationMarker;
    let routePolyline;
    let currentUserLocation = null;
    let selectedLocation = null;
    let savedLocations = [];
    let isCompassCalibrated = false;
    let isDirectionCaptured = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    function initMaps() {
        console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Leaflet –∫–∞—Ä—Ç—ã...');
        initializeLeafletMap();
        loadSavedLocations();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
        if (window.destinationData) {
            setTimeout(() => {
                startAutoNavigation();
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (selectedLocation && currentUserLocation && !routePolyline) {
                        console.log('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞...');
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                    }
                }, 3000);
            }, 1000);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Leaflet –∫–∞—Ä—Ç—ã
    function initializeLeafletMap() {
        try {
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –ê–ª–º–∞—Ç—ã
            map = L.map('map').setView([43.238293, 76.889709], 13);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                selectLocationOnMap(e.latlng);
            });

            console.log('‚úÖ Leaflet –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            speakText('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            requestUserLocation();

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            speakText('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã');
        }
    }

    // –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function requestUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: linear-gradient(45deg, #4CAF50, #45a049); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 3px solid white; 
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                animation: pulse 2s infinite;
                                font-size: 18px;
                            ">
                            üìç
                            </div>
                            <style>
                            @keyframes pulse {
                                0% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                                50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6); }
                                100% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                            }
                            </style>`,
                            className: 'current-location-icon',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(map);

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                    currentLocationMarker.bindPopup(`
                        <div style="text-align: center; font-weight: bold;">
                            <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                            <div style="font-size: 12px; color: #666;">
                                –®–∏—Ä–æ—Ç–∞: ${currentUserLocation.lat.toFixed(6)}<br>
                                –î–æ–ª–≥–æ—Ç–∞: ${currentUserLocation.lng.toFixed(6)}
                            </div>
                        </div>
                    `);

                    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞
                    if (selectedLocation && window.destinationData) {
                        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Ç–∞–∫ —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞
                        const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                        
                        // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ. –ú–∞—Ä—à—Ä—É—Ç –∫ –º–µ—Å—Ç—É ${window.destinationData.name} –ø–æ—Å—Ç—Ä–æ–µ–Ω. –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é.`);
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                        setTimeout(() => {
                            startNavigation();
                        }, 2000);
                    } else if (selectedLocation) {
                        // –î–ª—è –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π)
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ. –°—Ç—Ä–æ—é –º–∞—Ä—à—Ä—É—Ç –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—Ç—É.`);
                    } else {
                        // –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                        map.setView([currentUserLocation.lat, currentUserLocation.lng], 15);
                        speakText(`–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ. –®–∏—Ä–æ—Ç–∞ ${currentUserLocation.lat.toFixed(3)}, –¥–æ–ª–≥–æ—Ç–∞ ${currentUserLocation.lng.toFixed(3)}. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.`);
                    }
                },
                function(error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –¥–ª—è –ª—É—á—à–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GPS –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                            break;
                        default:
                            errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.';
                            break;
                    }
                    speakText(errorMessage + ' –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            speakText('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ –≤—Ä—É—á–Ω—É—é.');
        }
    }

    // –í—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    function selectLocationOnMap(latlng) {
        selectedLocation = {
            lat: latlng.lat,
            lng: latlng.lng
        };

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
        }

        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
        selectedLocationMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
            icon: L.divIcon({
                html: '<div style="background: #FF5722; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üìç</div>',
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ
        document.getElementById('selectedCoords').textContent = 
            `–®–∏—Ä–æ—Ç–∞: ${selectedLocation.lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${selectedLocation.lng.toFixed(6)}`;
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('saveLocationBtn').disabled = false;

        speakText(`–ú–µ—Å—Ç–æ –≤—ã–±—Ä–∞–Ω–æ. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${selectedLocation.lat.toFixed(3)}, ${selectedLocation.lng.toFixed(3)}`);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
        if (currentUserLocation) {
            calculateAndDisplayRoute(currentUserLocation, selectedLocation);
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–∞—Å–∞
    function startCompassCalibration() {
        speakText('–ù–∞—á–∏–Ω–∞—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –∫–æ–º–ø–∞—Å–∞. –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≤–∏–¥–µ –≤–æ—Å—å–º—ë—Ä–∫–∏.');
        document.getElementById('statusText').textContent = '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞... –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≤–∏–¥–µ –≤–æ—Å—å–º—ë—Ä–∫–∏';
        document.getElementById('calibrateBtn').disabled = true;

        // –°–∏–º—É–ª—è—Ü–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞—Å–∞
        setTimeout(() => {
            fetch('/calibrate_compass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'calibrate' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isCompassCalibrated = true;
                    document.getElementById('statusText').textContent = '–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.';
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('calibrateBtn').textContent = '‚úÖ –ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
                    speakText('–ö–æ–º–ø–∞—Å —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:', error);
                document.getElementById('calibrateBtn').disabled = false;
                speakText('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            });
        }, 3000);
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function captureView() {
        if (!isCompassCalibrated) {
            speakText('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–ø–∞—Å');
            return;
        }

        speakText('–û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞ —Å –ø–æ–º–æ—â—å—é –∫–∞–º–µ—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞');
        document.getElementById('statusText').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...';
        document.getElementById('captureBtn').disabled = true;

        // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞—Ö–≤–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        setTimeout(() => {
            fetch('/capture_view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'capture' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isDirectionCaptured = true;
                    document.getElementById('statusText').textContent = '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ! –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é.';
                    document.getElementById('captureBtn').textContent = '‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    speakText('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', error);
                document.getElementById('captureBtn').disabled = false;
                speakText('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            });
        }, 2000);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞)
    function getCurrentLocation() {
        speakText('–û–±–Ω–æ–≤–ª—è—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
        document.getElementById('statusText').textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
        if (currentLocationMarker) {
            map.removeLayer(currentLocationMarker);
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        requestUserLocation();
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ (—ç–º—É–ª—è—Ü–∏—è)
    function calculateAndDisplayRoute(origin, destination) {
        console.log('üõ£Ô∏è –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –æ—Ç', origin, '–¥–æ', destination);
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }
        
        // –°–æ–∑–¥–∞–µ–º —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        const route = generateEmulatedRoute(origin, destination);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
        const latlngs = route.path.map(point => [point.lat, point.lng]);
        routePolyline = L.polyline(latlngs, {
            color: '#FF0000',
            weight: 4,
            opacity: 0.8
        }).addTo(map);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
        map.fitBounds(routePolyline.getBounds());
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
        document.getElementById('routeInfo').classList.remove('hidden');
        document.getElementById('routeDetails').innerHTML = `
            <div style="color: white; text-align: left;">
                <p><strong>üö∂ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${route.legs[0].distance.text}</p>
                <p><strong>‚è±Ô∏è –í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> ${route.legs[0].duration.text}</p>
                <p><strong>üìç –û—Ç:</strong> ${route.legs[0].start_address}</p>
                <p><strong>üéØ –î–æ:</strong> ${route.legs[0].end_address}</p>
            </div>
        `;

        speakText(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${route.legs[0].distance.text}, –≤—Ä–µ–º—è –≤ –ø—É—Ç–∏ ${route.legs[0].duration.text}`);
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    function generateEmulatedRoute(origin, destination) {
        const startLat = origin.lat;
        const startLng = origin.lng;
        const endLat = destination.lat;
        const endLng = destination.lng;
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—Ä–µ–º—è
        const distance = calculateDistance(startLat, startLng, endLat, endLng);
        const distanceMeters = Math.round(distance * 1000);
        const durationMinutes = Math.round(distanceMeters / 80); // ~5 –∫–º/—á –ø–µ—à–∫–æ–º
        
        // –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        const path = generateWalkingPath(startLat, startLng, endLat, endLng);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å–∞
        const startAddress = generateAlmatyAddress(startLat, startLng);
        const endAddress = generateAlmatyAddress(endLat, endLng);
        
        return {
            path: path,
            legs: [{
                distance: {
                    text: distanceMeters < 1000 ? `${distanceMeters} –º` : `${(distance).toFixed(1)} –∫–º`,
                    value: distanceMeters
                },
                duration: {
                    text: durationMinutes < 60 ? `${durationMinutes} –º–∏–Ω` : `${Math.floor(durationMinutes/60)} —á ${durationMinutes%60} –º–∏–Ω`,
                    value: durationMinutes * 60
                },
                start_address: startAddress,
                end_address: endAddress
            }]
        };
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –ø–µ—à–µ—Ö–æ–¥–Ω–æ–≥–æ –ø—É—Ç–∏
    function generateWalkingPath(startLat, startLng, endLat, endLng) {
        const path = [];
        const steps = 8; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        const randomFactor = 0.001; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        
        for (let i = 0; i <= steps; i++) {
            const ratio = i / steps;
            
            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–ª—É—á–∞–π–Ω—ã–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º
            const lat = startLat + (endLat - startLat) * ratio + (Math.random() - 0.5) * randomFactor;
            const lng = startLng + (endLng - startLng) * ratio + (Math.random() - 0.5) * randomFactor;
            
            path.push({ lat: lat, lng: lng });
        }
        
        return path;
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –ê–ª–º–∞—Ç—ã
    function generateAlmatyAddress(lat, lng) {
        const almatyStreets = [
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –ê–±–∞—è', '—É–ª–∏—Ü–∞ –°–∞—Ç–ø–∞–µ–≤–∞', '–ø—Ä–æ—Å–ø–µ–∫—Ç –ê–ª—å-–§–∞—Ä–∞–±–∏',
            '—É–ª–∏—Ü–∞ –¢–æ–ª–µ –±–∏', '–ø—Ä–æ—Å–ø–µ–∫—Ç –ù–∞–∑–∞—Ä–±–∞–µ–≤–∞', '—É–ª–∏—Ü–∞ –ñ–∏–±–µ–∫ –ñ–æ–ª—ã',
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –î–æ—Å—Ç—ã–∫', '—É–ª–∏—Ü–∞ –ú–∞–Ω–∞—Å–∞', '—É–ª–∏—Ü–∞ –ë–æ–≥–µ–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞',
            '–ø—Ä–æ—Å–ø–µ–∫—Ç –†–∞–π—ã–º–±–µ–∫–∞', '—É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–≥–∞–∑—ã', '—É–ª–∏—Ü–∞ –ö–∞–±–∞–Ω–±–∞–π –±–∞—Ç—ã—Ä–∞'
        ];
        
        // –í—ã–±–∏—Ä–∞–µ–º —É–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
        const streetIndex = Math.floor((lat + lng) * 1000) % almatyStreets.length;
        const street = almatyStreets[streetIndex];
        const houseNumber = Math.floor((lat + lng) * 10000) % 200 + 1;
        
        return `${street}, ${houseNumber}, –ê–ª–º–∞—Ç—ã`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
    function saveCurrentLocationOnMap() {
        if (!selectedLocation) {
            speakText('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
            return;
        }
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('locationName').focus();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏
    function saveSelectedLocation() {
        const name = document.getElementById('locationName').value.trim();
        const description = document.getElementById('locationDescription').value.trim();
        const category = document.getElementById('locationCategory').value;

        if (!name) {
            speakText('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
            document.getElementById('locationName').focus();
            return;
        }

        if (!selectedLocation) {
            speakText('–ú–µ—Å—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
            return;
        }

        const locationData = {
            location: selectedLocation,
            name: name,
            description: description,
            category: category
        };

        fetch('/save_location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                speakText(`–ú–µ—Å—Ç–æ ${name} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                clearSelection();
                loadSavedLocations();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–æ–π
                showNotification(`–ú–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞: ${data.static_url}`, 'success');
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            speakText('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ—Å—Ç–∞');
        });
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
    function clearSelection() {
        selectedLocation = null;
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        document.getElementById('selectedLocationInfo').classList.add('hidden');
        document.getElementById('saveLocationBtn').disabled = true;
        document.getElementById('locationName').value = '';
        document.getElementById('locationDescription').value = '';
        document.getElementById('locationCategory').value = 'general';
    }

    // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã
    function clearMap() {
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
        }
        document.getElementById('routeInfo').classList.add('hidden');
        clearSelection();
        speakText('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç
    async function loadSavedLocations() {
        try {
            const response = await fetch('/list_saved_locations');
            const data = await response.json();
            
            if (data.success && data.locations.length > 0) {
                savedLocations = data.locations;
                displaySavedLocations();
            } else {
                document.getElementById('savedLocationsList').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: white; padding: 40px;">
                        <p>üó∫Ô∏è –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç</p>
                        <p style="opacity: 0.7;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç:', error);
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç
    function displaySavedLocations() {
        const container = document.getElementById('savedLocationsList');
        container.innerHTML = savedLocations.map(location => `
            <div class="saved-location-card" onclick="selectSavedLocation('${location.id}')">
                <h4>${getCategoryIcon(location.category)} ${location.name}</h4>
                <p>${location.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                <p style="font-size: 0.8em; opacity: 0.7;">
                    üíæ ${formatDate(location.timestamp)} | üëÅÔ∏è ${location.access_count}
                </p>
                <div class="location-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); navigateToSavedLocation('${location.id}')">
                        üß≠ 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); showOnMap('${location.id}')">
                        üó∫Ô∏è 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); copyLocationLink('${location.id}')">
                        üîó 
                    </button>
                </div>
            </div>
        `).join('');
    }

    // –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
    function selectSavedLocation(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            selectedLocation = { lat: location.lat, lng: location.lng };
            selectLocationOnMap({ lat: location.lat, lng: location.lng });
            map.setView([location.lat, location.lng], 16);
            speakText(`–í—ã–±—Ä–∞–Ω–æ –º–µ—Å—Ç–æ ${location.name}`);
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ
    function showOnMap(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            map.setView([location.lat, location.lng], 17);
            
            const marker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    html: '<div style="background: #FF9800; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: bounce 2s 3;">üìç</div>',
                    className: 'custom-div-icon',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                })
            }).addTo(map);

            setTimeout(() => map.removeLayer(marker), 6000);
            speakText(`–ü–æ–∫–∞–∑—ã–≤–∞—é –º–µ—Å—Ç–æ ${location.name} –Ω–∞ –∫–∞—Ä—Ç–µ`);
        }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É –º–µ—Å—Ç—É
    function navigateToSavedLocation(locationId) {
        window.location.href = `/location/${locationId}`;
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    function copyLocationLink(locationId) {
        const link = `${window.location.origin}/location/${locationId}`;
        navigator.clipboard.writeText(link).then(() => {
            speakText('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            speakText('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏');
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
    function startAutoNavigation() {
        console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫:', window.destinationData);
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        const destination = {
            lat: window.destinationData.latitude, 
            lng: window.destinationData.longitude
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ
        selectedLocation = destination;
        
        // –°–†–ê–ó–£ —Å–æ–∑–¥–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
        }
        
        selectedLocationMarker = L.marker([destination.lat, destination.lng], {
            icon: L.divIcon({
                html: `<div style="
                    background: linear-gradient(45deg, #FF5722, #E64A19); 
                    color: white; 
                    border-radius: 50%; 
                    width: 45px; 
                    height: 45px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    border: 3px solid white; 
                    box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6);
                    animation: destinationPulse 2s infinite;
                    font-size: 20px;
                ">üéØ</div>
                <style>
                @keyframes destinationPulse {
                    0% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6); }
                    50% { transform: scale(1.15); box-shadow: 0 6px 30px rgba(255, 87, 34, 0.8); }
                    100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6); }
                }
                </style>`,
                className: 'destination-marker',
                iconSize: [45, 45],
                iconAnchor: [22, 22]
            })
        }).addTo(map);
        
        // –ü–æ–ª—É—á–∞–µ–º –¢–û–ß–ù–´–ô –∞–¥—Ä–µ—Å –¥–ª—è –º–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        getExactAddress(destination.lat, destination.lng).then(exactAddress => {
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—ä—è–≤–ª—è–µ–º –æ –Ω–∞—á–∞–ª–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –¢–û–ß–ù–´–ú –∞–¥—Ä–µ—Å–æ–º
            speakText(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ—é –º–∞—Ä—à—Ä—É—Ç –¥–æ –º–µ—Å—Ç–∞ ${window.destinationData.name}, —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å: ${exactAddress}. –ù–∞—á–∏–Ω–∞—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –∫–æ–º–ø–∞—Å–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å —Ç–æ—á–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º
            selectedLocationMarker.bindPopup(`
                <div style="text-align: center; font-weight: bold; min-width: 250px;">
                    <div style="font-size: 18px; color: #FF5722; margin-bottom: 8px;">
                        üéØ ${window.destinationData.name}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                        ${window.destinationData.description || '–ú–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'}
                    </div>
                    <div style="font-size: 12px; color: #444; margin-bottom: 8px; background: #f0f0f0; padding: 8px; border-radius: 6px;">
                        üìç <strong>–¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å:</strong><br>${exactAddress}
                    </div>
                    <div style="font-size: 11px; color: #999;">
                        –®–∏—Ä–æ—Ç–∞: ${destination.lat.toFixed(6)}<br>
                        –î–æ–ª–≥–æ—Ç–∞: ${destination.lng.toFixed(6)}
                    </div>
                    <div style="margin-top: 8px; padding: 4px 8px; background: #FF5722; color: white; border-radius: 12px; font-size: 10px;">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
                    </div>
                </div>
            `).openPopup();
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ
        document.getElementById('selectedCoords').textContent = 
            `–®–∏—Ä–æ—Ç–∞: ${destination.lat.toFixed(6)}, –î–æ–ª–≥–æ—Ç–∞: ${destination.lng.toFixed(6)}`;
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–µ
        document.getElementById('locationName').value = window.destinationData.name;
        document.getElementById('locationDescription').value = window.destinationData.description || '';
        document.getElementById('locationCategory').value = window.destinationData.category || 'general';
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–º–µ—Å—Ç–æ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
        document.getElementById('saveLocationBtn').disabled = true;
        document.getElementById('saveLocationBtn').textContent = '‚úÖ –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
        
        // –°–ù–ê–ß–ê–õ–ê —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        map.setView([destination.lat, destination.lng], 16);
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—ç—Ç–æ –ø–æ–∫–∞–∂–µ—Ç –æ–±–∞ –º–∞—Ä–∫–µ—Ä–∞)
        setTimeout(() => {
            requestUserLocation();
        }, 1000);
        
        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ö–ê–õ–ò–ë–†–û–í–ö–ê –ö–û–ú–ü–ê–°–ê (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        setTimeout(() => {
            autoCompassCalibration();
        }, 2000);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
    async function getExactAddress(lat, lng) {
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Nominatim API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—á–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lng=${lng}&zoom=18&addressdetails=1&accept-language=ru`);
            const data = await response.json();
            
            if (data && data.display_name) {
                // –ü–∞—Ä—Å–∏–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                const address = data.address || {};
                let formattedAddress = '';
                
                if (address.road) formattedAddress += address.road;
                if (address.house_number) formattedAddress += `, ${address.house_number}`;
                if (address.suburb) formattedAddress += `, —Ä–∞–π–æ–Ω ${address.suburb}`;
                if (address.city || address.town) formattedAddress += `, ${address.city || address.town}`;
                
                return formattedAddress || data.display_name;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
        }
        
        // Fallback - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
        return generateAlmatyAddress(lat, lng);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞ (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function autoCompassCalibration() {
        speakText('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∫–æ–º–ø–∞—Å');
        document.getElementById('statusText').textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞...';
        document.getElementById('calibrateBtn').disabled = true;
        document.getElementById('calibrateBtn').textContent = '‚è≥ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞...';

        // –≠–º—É–ª—è—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
        setTimeout(() => {
            fetch('/calibrate_compass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'calibrate' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isCompassCalibrated = true;
                    document.getElementById('statusText').textContent = '–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!';
                    document.getElementById('calibrateBtn').textContent = '‚úÖ –ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
                    speakText('–ö–æ–º–ø–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    setTimeout(() => {
                        autoCaptureView();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏:', error);
                speakText('–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞—Å–∞. –ü—Ä–æ–¥–æ–ª–∂–∞—é –±–µ–∑ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏.');
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                setTimeout(() => {
                    autoCaptureView();
                }, 1000);
            });
        }, 2000);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    function autoCaptureView() {
        speakText('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞');
        document.getElementById('statusText').textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...';
        document.getElementById('captureBtn').disabled = true;
        document.getElementById('captureBtn').textContent = '‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';

        // –≠–º—É–ª—è—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            fetch('/capture_view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'capture' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isDirectionCaptured = true;
                    document.getElementById('statusText').textContent = '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ì–æ—Ç–æ–≤ –∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.';
                    document.getElementById('captureBtn').textContent = '‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
                    speakText('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –ü–æ–ª—É—á–∞—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.');
                    
                    // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞, –∂–¥–µ–º –µ–µ
                    if (!currentUserLocation) {
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                        requestUserLocation();
                    } else {
                        // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è —É–∂–µ –µ—Å—Ç—å, —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω. –ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –º–µ—Å—Ç—É ${window.destinationData.name}.`);
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', error);
                speakText('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∞—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é.');
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (!currentUserLocation) {
                    requestUserLocation();
                } else {
                    calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                }
            });
        }, 2000);
    }

    // –ù–∞—á–∞–ª–æ –≥–æ–ª–æ—Å–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function startNavigation() {
        if (!currentUserLocation || !selectedLocation) {
            speakText('–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
            return;
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const distance = calculateDistance(
            currentUserLocation.lat, currentUserLocation.lng, 
            selectedLocation.lat, selectedLocation.lng
        );
        
        const bearing = calculateBearing(
            currentUserLocation.lat, currentUserLocation.lng,
            selectedLocation.lat, selectedLocation.lng
        );
        
        const direction = getDirectionFromBearing(bearing);
        const distanceText = distance < 1 ? `${Math.round(distance * 1000)} –º–µ—Ç—Ä–æ–≤` : `${distance.toFixed(1)} –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤`;
        
        if (window.destinationData) {
            // –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            speakText(`–ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∫ –º–µ—Å—Ç—É ${window.destinationData.name}. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏: ${distanceText}. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}. –ò–¥–∏—Ç–µ –ø—Ä—è–º–æ, —è –±—É–¥—É –≤–∞—Å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–∞–∂–∏—Ç–µ "–ì–¥–µ —è" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.`);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            startPeriodicNavigation();
        } else {
            speakText(`–ù–∞—á–∏–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceText}, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}. –°–ª–µ–¥—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —É–∫–∞–∑–∞–Ω–∏—è–º.`);
        }
    }

    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
    function startPeriodicNavigation() {
        const navigationInterval = setInterval(() => {
            if (!currentUserLocation || !selectedLocation) {
                clearInterval(navigationInterval);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    const distance = calculateDistance(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    // –ï—Å–ª–∏ –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–≤ —Ä–∞–¥–∏—É—Å–µ 50 –º–µ—Ç—Ä–æ–≤)
                    if (distance < 0.05) {
                        clearInterval(navigationInterval);
                        speakText(`–í—ã –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${window.destinationData ? window.destinationData.name : '–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ'}. –ù–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`);
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const bearing = calculateBearing(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    const direction = getDirectionFromBearing(bearing);
                    const distanceText = distance < 1 ? `${Math.round(distance * 1000)} –º–µ—Ç—Ä–æ–≤` : `${distance.toFixed(1)} –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤`;
                    
                    speakText(`–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ. –î–æ —Ü–µ–ª–∏: ${distanceText}. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${direction}.`);
                },
                (error) => {
                    console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 10000 }
            );
        }, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    }

    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –∞–∑–∏–º—É—Ç—É
    function calculateBearing(lat1, lng1, lat2, lng2) {
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const lat1Rad = lat1 * Math.PI / 180;
        const lat2Rad = lat2 * Math.PI / 180;
        
        const y = Math.sin(dLng) * Math.cos(lat2Rad);
        const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                  Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
        
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞ –≤ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function getDirectionFromBearing(bearing) {
        const directions = [
            '—Å–µ–≤–µ—Ä', '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫', '–≤–æ—Å—Ç–æ–∫', '—é–≥–æ-–≤–æ—Å—Ç–æ–∫',
            '—é–≥', '—é–≥–æ-–∑–∞–ø–∞–¥', '–∑–∞–ø–∞–¥', '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥'
        ];
        
        const index = Math.round(bearing / 45) % 8;
        return `–Ω–∞ ${directions[index]}`;
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getCategoryIcon(category) {
        const icons = {
            'general': 'üìç', 'home': 'üè†', 'work': 'üè¢', 'shop': 'üõí',
            'medical': 'üè•', 'education': 'üéì', 'transport': 'üöå',
            'food': 'üçΩÔ∏è', 'entertainment': 'üé¨'
        };
        return icons[category] || 'üìç';
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', function() {
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Leaflet
        if (typeof L !== 'undefined') {
            initMaps();
        } else {
            setTimeout(() => {
                if (typeof L !== 'undefined') {
                    initMaps();
                } else {
                    console.error('Leaflet –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    speakText('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã');
                }
            }, 1000);
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    `;
    document.head.appendChild(style);
</script>

    </div>
    
    <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="global-voice-panel" role="region" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button id="globalVoiceBtn" class="global-voice-btn focusable" 
                aria-label="–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É" 
                title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã">
            üé§
        </button>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ -->
        <div id="microphoneStatus" class="microphone-status" style="display: none;">
            <span id="micStatusIcon">üé§</span>
            <span id="micStatusText">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤</span>
        </div>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é -->
        <div id="voiceInstructions" class="voice-instructions" style="display: none;">
            <div class="instruction-content">
                <h3>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <ul>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏–ª–∏ –∫–ª–∞–≤–∏—à—É –ü—Ä–æ–±–µ–ª</li>
                    <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
                    <li>–ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ –∏ –≥—Ä–æ–º–∫–æ</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –µ—â–µ —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã</li>
                </ul>
                <button onclick="hideInstructions()" class="btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </div>
    
    <!-- –ë–∞–∑–æ–≤–∞—è JavaScript —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        let isListening = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoiceControls();
            initializeAccessibility();
            announcePageLoad();
            checkMicrophoneSupport();
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function initializeVoiceControls() {
            const globalVoiceBtn = document.getElementById('globalVoiceBtn');
            if (globalVoiceBtn) {
                globalVoiceBtn.addEventListener('click', toggleGlobalVoice);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        async function toggleGlobalVoice() {
            if (isListening) {
                stopListening();
            } else {
                await startListening();
            }
        }
        
        // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
        async function startListening() {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome, Firefox –∏–ª–∏ Safari.');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ MediaRecorder
                if (!window.MediaRecorder) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –º–µ–¥–∏–∞. –û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.');
                }

                showVoiceStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                speakText('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö MIME —Ç–∏–ø–æ–≤
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = ''; // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        }
                    }
                }

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    processVoiceCommand();
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ: ' + event.error.message, 'error');
                    resetVoiceButton();
                };
                
                mediaRecorder.start();
                isListening = true;
                
                const voiceBtn = document.getElementById('globalVoiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.add('listening');
                    voiceBtn.innerHTML = '‚èπÔ∏è';
                    voiceBtn.setAttribute('aria-label', '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã');
                }
                
                showVoiceStatus('–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å!');
                speakText('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω. –ì–æ–≤–æ—Ä–∏—Ç–µ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É.');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (isListening) {
                        stopListening();
                        speakText('–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    }
                }, 30000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                
                let errorMessage = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.';
                } else {
                    errorMessage += error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                }
                
                showNotification(errorMessage, 'error');
                speakText('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.');
                resetVoiceButton();
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
        function stopListening() {
            if (mediaRecorder && isListening) {
                try {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏:', error);
                }
                
                isListening = false;
                
                const voiceBtn = document.getElementById('globalVoiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.remove('listening');
                    voiceBtn.innerHTML = 'üé§';
                    voiceBtn.setAttribute('aria-label', '–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É');
                }
                
                showVoiceStatus('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∫–æ–º–∞–Ω–¥—É...');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö)
        function processVoiceCommand() {
            try {
                // –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - –±—É–¥–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã...');
                
                const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                
                if (audioBlob.size === 0) {
                    throw new Error('–ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –µ—â–µ —Ä–∞–∑.');
                }
                
                console.log('–ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∞–Ω–æ:', audioBlob.size, '–±–∞–π—Ç');
                speakText('–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                speakText('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } finally {
                hideVoiceStatus();
            }
        }
        
        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        function showVoiceStatus(text) {
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceStatusText = document.getElementById('voiceStatusText');
            voiceStatusText.textContent = text;
            voiceStatus.classList.add('show');
        }
        
        // –°–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.classList.remove('show');
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(text, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        function initializeAccessibility() {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ARIA-–º–µ—Ç–æ–∫
            const focusableElements = document.querySelectorAll('.focusable');
            focusableElements.forEach(element => {
                if (!element.getAttribute('tabindex')) {
                    element.setAttribute('tabindex', '0');
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.addEventListener('keydown', handleKeyboardNavigation);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function handleKeyboardNavigation(event) {
            // –ü—Ä–æ–±–µ–ª –∏–ª–∏ Enter –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if ((event.code === 'Space' || event.code === 'Enter') && 
                event.target.id === 'globalVoiceBtn') {
                event.preventDefault();
                toggleGlobalVoice();
            }
            
            // Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏
            if (event.code === 'Escape' && isListening) {
                stopListening();
                speakText('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞');
            }
        }
        
        // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function announcePageLoad() {
            const pageTitle = document.querySelector('.main-header h1');
            if (pageTitle) {
                setTimeout(() => {
                    speakText(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${pageTitle.textContent}`);
                }, 1000);
            }
        }
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    error => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function animateElements() {
            const elements = document.querySelectorAll('.nav-card, .btn');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('animate-in');
                }, index * 100);
            });
        }
        
        // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        window.addEventListener('load', animateElements);
        
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function resetVoiceButton() {
            isListening = false;
            const voiceBtn = document.getElementById('globalVoiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = 'üé§';
                voiceBtn.setAttribute('aria-label', '–ù–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É');
            }
            hideVoiceStatus();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function checkMicrophoneSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showMicrophoneStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                speakText('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ');
                return;
            }
            
            if (!window.MediaRecorder) {
                showMicrophoneStatus('–ó–∞–ø–∏—Å—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                speakText('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –º–µ–¥–∏–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            navigator.permissions.query({ name: 'microphone' }).then(function(result) {
                if (result.state === 'granted') {
                    showMicrophoneStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤', 'success');
                } else if (result.state === 'prompt') {
                    showMicrophoneStatus('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞', '');
                } else {
                    showMicrophoneStatus('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                    showInstructions();
                }
            }).catch(function(error) {
                console.log('Permissions API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', error);
                showMicrophoneStatus('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞', '');
            });
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function showMicrophoneStatus(text, type) {
            const statusElement = document.getElementById('microphoneStatus');
            const iconElement = document.getElementById('micStatusIcon');
            const textElement = document.getElementById('micStatusText');
            
            if (statusElement && iconElement && textElement) {
                textElement.textContent = text;
                statusElement.className = `microphone-status ${type}`;
                
                if (type === 'error') {
                    iconElement.textContent = '‚ùå';
                } else if (type === 'success') {
                    iconElement.textContent = '‚úÖ';
                } else {
                    iconElement.textContent = 'üé§';
                }
                
                statusElement.style.display = 'flex';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (type !== 'error') {
                        statusElement.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // –ü–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function showInstructions() {
            const instructionsElement = document.getElementById('voiceInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'flex';
                speakText('–ü–æ–∫–∞–∑–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
            }
        }

        // –°–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function hideInstructions() {
            const instructionsElement = document.getElementById('voiceInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'none';
                speakText('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç—ã');
            }
        }
    </script>
    
    
</body>
</html> 