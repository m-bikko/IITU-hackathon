<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAla - Навигация</title>
    
    <!-- Оптимизация для слепых пользователей -->
    <meta name="description" content="Умная навигационная система для слепых людей с голосовым ассистентом">
    
    <!-- OpenStreetMap Leaflet для карт (без API ключей) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Стили оптимизированные для слабовидящих -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
            font-size: 18px;
            line-height: 1.6;
            padding: 20px;
        }
        
        /* Высокий контраст для слабовидящих */
        .high-contrast {
            background: #000;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .main-header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-header p {
            font-size: 1.3em;
            opacity: 0.9;
        }
        
        .nav-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .nav-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .nav-card:hover, .nav-card:focus {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            border-color: #fff;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .nav-card .icon {
            font-size: 4em;
            margin-bottom: 15px;
            display: block;
        }
        
        .nav-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .nav-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 150px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.4);
        }
        
        .btn-large {
            padding: 20px 40px;
            font-size: 1.3em;
            min-width: 200px;
        }
        
        /* Глобальные голосовые элементы управления */
        .global-voice-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .global-voice-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .global-voice-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
        }
        
        .global-voice-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .global-voice-btn.listening {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            animation: pulse-listening 1.5s infinite;
        }
        
        .global-voice-btn.listening::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border-radius: 50%;
            opacity: 0.3;
            animation: wave 2s infinite;
        }
        
        @keyframes pulse-listening {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes wave {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .microphone-status {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease;
        }
        
        .microphone-status.error {
            background: rgba(255, 107, 107, 0.95);
            color: white;
        }
        
        .microphone-status.success {
            background: rgba(76, 175, 80, 0.95);
            color: white;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .voice-instructions {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .instruction-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            text-align: center;
            animation: modalAppear 0.3s ease;
        }
        
        .instruction-content h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .instruction-content ul {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .instruction-content li {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        @keyframes modalAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                padding: 10px;
            }
            
            .main-header h1 {
                font-size: 2em;
            }
            
            .nav-cards {
                grid-template-columns: 1fr;
            }
            
            .nav-card {
                padding: 20px;
            }
            
            .nav-card .icon {
                font-size: 3em;
            }
        }
        
        /* Анимации */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        /* Специальные стили для навигации */
        .map-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .compass-indicator {
            width: 100px;
            height: 100px;
            border: 3px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            position: relative;
        }
        
        .compass-needle {
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom, #ff6b6b, #fff);
            position: absolute;
            transform-origin: center bottom;
            transition: transform 0.5s ease;
        }
        
        /* Уведомления */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1001;
            display: none;
            max-width: 90%;
            text-align: center;
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .notification.show {
            display: block;
            animation: slideInDown 0.3s ease;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateX(-50%) translateY(-100%);
            }
            to {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Статус голосового ассистента */
        .voice-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            z-index: 1000;
            display: none;
        }
        
        .voice-status.show {
            display: block;
        }
        
        /* Доступность */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Фокус для клавиатурной навигации */
        .focusable:focus {
            outline: 3px solid #ffff00;
            outline-offset: 2px;
        }
        
        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .global-voice-panel {
                bottom: 20px;
                right: 20px;
            }
            
            .global-voice-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8em;
            }
            
            .microphone-status {
                font-size: 0.8em;
                padding: 6px 12px;
            }
            
            .instruction-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
    
    
</head>
<body>
    <!-- Голосовой статус -->
    <div class="voice-status" id="voiceStatus">
        <span id="voiceStatusText">Голосовой ассистент готов</span>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- Основное содержимое -->
    <div class="container">
        
<div class="navigation-container">
    <header class="nav-header">
        <h1>🧭 Умная Навигация</h1>
        <p id="statusText">Нажмите кнопку для начала настройки компаса</p>
    </header>

    <!-- Панель управления -->
    <div class="control-panel">
        <div class="control-group">
            <button id="calibrateBtn" class="control-btn primary" onclick="startCompassCalibration()">
                🧭 Настроить компас
            </button>
            <button id="captureBtn" class="control-btn secondary" onclick="captureView()" disabled>
                📸 Определить направление
            </button>
            <button id="getCurrentLocationBtn" class="control-btn" onclick="getCurrentLocation()">
                📍 Моё местоположение
            </button>
        </div>
        
        <div class="control-group">
            <button id="saveLocationBtn" class="control-btn success" onclick="saveCurrentLocationOnMap()" disabled>
                💾 Сохранить место
            </button>
            <button id="clearMapBtn" class="control-btn warning" onclick="clearMap()">
                🗑️ Очистить карту
            </button>
        </div>
    </div>

    <!-- Google Maps контейнер -->
    <div class="map-container">
        <div id="map" class="leaflet-map"></div>
        <div class="map-controls">
            <div class="map-info">
                <div id="selectedLocationInfo" class="location-info hidden">
                    <h4>📍 Выбранное место</h4>
                    <p id="selectedCoords">Координаты будут показаны здесь</p>
                    <input type="text" id="locationName" placeholder="Введите название места..." class="location-input">
                    <textarea id="locationDescription" placeholder="Описание (необязательно)..." class="location-input"></textarea>
                    <select id="locationCategory" class="location-input">
                        <option value="general">Общее</option>
                        <option value="home">Дом</option>
                        <option value="work">Работа</option>
                        <option value="shop">Магазин</option>
                        <option value="medical">Медицина</option>
                        <option value="education">Образование</option>
                        <option value="transport">Транспорт</option>
                        <option value="food">Еда</option>
                        <option value="entertainment">Развлечения</option>
                    </select>
                    <button onclick="saveSelectedLocation()" class="save-btn">💾 Сохранить место</button>
                    <button onclick="clearSelection()" class="cancel-btn">❌ Отменить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Сохранённые места -->
    <div class="saved-locations-section">
        <h3>📍 Сохранённые места</h3>
        <div id="savedLocationsList" class="saved-locations-grid">
            <!-- Места будут загружены динамически -->
        </div>
    </div>

    <!-- Маршрут информация -->
    <div id="routeInfo" class="route-info hidden">
        <h3>🛣️ Маршрут</h3>
        <div id="routeDetails"></div>
        <button onclick="startNavigation()" class="nav-btn">🧭 Начать навигацию</button>
    </div>
</div>

<!-- Destination data for auto-navigation -->

<script>
    window.destinationData = {&#34;name&#34;: &#34;\u0426\u0435\u043d\u0442\u0440 \u0410\u043b\u043c\u0430\u0442\u044b&#34;, &#34;description&#34;: &#34;\u041f\u043b\u043e\u0449\u0430\u0434\u044c \u0420\u0435\u0441\u043f\u0443\u0431\u043b\u0438\u043a\u0438 \u0432 \u0446\u0435\u043d\u0442\u0440\u0435 \u0433\u043e\u0440\u043e\u0434\u0430&#34;, &#34;latitude&#34;: 43.238293, &#34;longitude&#34;: 76.889709, &#34;category&#34;: &#34;general&#34;, &#34;id&#34;: &#34;47657cc3&#34;, &#34;auto_navigation&#34;: true, &#34;creation_time&#34;: &#34;2025-06-28T03:38:56.537758&#34;};
</script>


<style>
    .navigation-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .nav-header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }

    .nav-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: white;
    }

    .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .control-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .control-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 15px 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        min-width: 160px;
    }

    .control-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .control-btn:disabled {
        background: linear-gradient(45deg, #9e9e9e, #757575);
        cursor: not-allowed;
        opacity: 0.6;
    }

    .control-btn.primary {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .control-btn.primary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .control-btn.secondary {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .control-btn.secondary:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }

    .control-btn.success {
        background: linear-gradient(45deg, #FF9800, #F57C00);
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .control-btn.success:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
    }

    .control-btn.warning {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .control-btn.warning:hover:not(:disabled) {
        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }

    .map-container {
        position: relative;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        overflow: hidden;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .leaflet-map {
        width: 100%;
        height: 600px;
        border-radius: 20px;
    }

    .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        pointer-events: none;
        z-index: 1000;
    }

    .map-info {
        pointer-events: auto;
    }

    .location-info {
        background: rgba(255,255,255,0.95);
        color: #333;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        backdrop-filter: blur(10px);
        max-width: 350px;
    }

    .location-info h4 {
        margin: 0 0 15px 0;
        font-size: 1.3em;
        color: #2c3e50;
    }

    .location-input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }

    .location-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    .save-btn, .cancel-btn, .nav-btn {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
    }

    .cancel-btn {
        background: linear-gradient(45deg, #f44336, #d32f2f);
    }

    .nav-btn {
        background: linear-gradient(45deg, #2196F3, #1976D2);
        font-size: 1.2em;
        padding: 15px 30px;
    }

    .save-btn:hover, .cancel-btn:hover, .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .saved-locations-section {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
    }

    .saved-locations-section h3 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8em;
        color: white;
    }

    .saved-locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    .saved-location-card {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .saved-location-card:hover {
        transform: translateY(-3px);
        background: rgba(255,255,255,0.2);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .saved-location-card h4 {
        margin: 0 0 10px 0;
        color: white;
        font-size: 1.3em;
    }

    .saved-location-card p {
        margin: 0 0 10px 0;
        color: rgba(255,255,255,0.8);
        font-size: 0.9em;
    }

    .location-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
    }

    .action-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.05);
    }

    .route-info {
        background: rgba(255,255,255,0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        text-align: center;
    }

    .route-info h3 {
        margin-bottom: 20px;
        color: white;
        font-size: 1.8em;
    }

    .hidden {
        display: none;
    }

    @media (max-width: 768px) {
        .control-group {
            justify-content: center;
        }
        
        .control-btn {
            min-width: 140px;
            padding: 12px 20px;
            font-size: 1em;
        }
        
        .leaflet-map {
            height: 400px;
        }
        
        .location-info {
            max-width: 280px;
        }
    }
</style>

<script>
    let map;
    let currentLocationMarker;
    let selectedLocationMarker;
    let routePolyline;
    let currentUserLocation = null;
    let selectedLocation = null;
    let savedLocations = [];
    let isCompassCalibrated = false;
    let isDirectionCaptured = false;

    // Инициализация карт (вызывается при загрузке страницы)
    function initMaps() {
        console.log('🗺️ Инициализация Leaflet карты...');
        initializeLeafletMap();
        loadSavedLocations();
        
        // Автоматическая навигация для статических ссылок
        if (window.destinationData) {
            setTimeout(() => {
                startAutoNavigation();
                // Дополнительная проверка построения маршрута через 3 секунды
                setTimeout(() => {
                    if (selectedLocation && currentUserLocation && !routePolyline) {
                        console.log('🔄 Повторная попытка построения маршрута...');
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                    }
                }, 3000);
            }, 1000);
        }
    }

    // Инициализация Leaflet карты
    function initializeLeafletMap() {
        try {
            // Создание карты с центром на Алматы
            map = L.map('map').setView([43.238293, 76.889709], 13);

            // Добавление слоя OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Обработчик клика по карте
            map.on('click', function(e) {
                selectLocationOnMap(e.latlng);
            });

            console.log('✅ Leaflet карта инициализирована успешно');
            speakText('Карта загружена. Получение вашего местоположения...');
            
            // Автоматически получаем геолокацию пользователя при загрузке
            requestUserLocation();

        } catch (error) {
            console.error('❌ Ошибка инициализации карты:', error);
            speakText('Ошибка инициализации карты');
        }
    }

    // Запрос геолокации пользователя при загрузке
    function requestUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentUserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Создаём маркер текущего местоположения с анимацией
                    currentLocationMarker = L.marker([currentUserLocation.lat, currentUserLocation.lng], {
                        icon: L.divIcon({
                            html: `<div style="
                                background: linear-gradient(45deg, #4CAF50, #45a049); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 3px solid white; 
                                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
                                animation: pulse 2s infinite;
                                font-size: 18px;
                            ">
                            📍
                            </div>
                            <style>
                            @keyframes pulse {
                                0% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                                50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6); }
                                100% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
                            }
                            </style>`,
                            className: 'current-location-icon',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        })
                    }).addTo(map);

                    // Добавляем всплывающую подсказку
                    currentLocationMarker.bindPopup(`
                        <div style="text-align: center; font-weight: bold;">
                            <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">📍 Ваше местоположение</div>
                            <div style="font-size: 12px; color: #666;">
                                Широта: ${currentUserLocation.lat.toFixed(6)}<br>
                                Долгота: ${currentUserLocation.lng.toFixed(6)}
                            </div>
                        </div>
                    `);

                    // Если есть место назначения (статическая ссылка), показываем оба маркера
                    if (selectedLocation && window.destinationData) {
                        // Центрируем карту так чтобы были видны оба маркера
                        const group = new L.featureGroup([currentLocationMarker, selectedLocationMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                        
                        // Строим маршрут
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`Ваше местоположение найдено. Маршрут к месту ${window.destinationData.name} построен. Начинаю автоматическую голосовую навигацию.`);
                        
                        // Автоматически запускаем навигацию
                        setTimeout(() => {
                            startNavigation();
                        }, 2000);
                    } else if (selectedLocation) {
                        // Для обычной навигации (не автоматической)
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`Ваше местоположение найдено. Строю маршрут к выбранному месту.`);
                    } else {
                        // Только текущее местоположение
                        map.setView([currentUserLocation.lat, currentUserLocation.lng], 15);
                        speakText(`Ваше местоположение найдено и отображено на карте. Широта ${currentUserLocation.lat.toFixed(3)}, долгота ${currentUserLocation.lng.toFixed(3)}. Нажмите на карту чтобы выбрать место назначения.`);
                    }
                },
                function(error) {
                    console.error('Ошибка геолокации при загрузке:', error);
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Доступ к геолокации запрещен. Разрешите доступ для лучшей навигации.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Местоположение недоступно. Проверьте GPS или интернет соединение.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Время ожидания геолокации истекло. Попробуйте снова.';
                            break;
                        default:
                            errorMessage = 'Произошла ошибка при определении местоположения.';
                            break;
                    }
                    speakText(errorMessage + ' Вы можете нажать кнопку "Моё местоположение" чтобы попробовать снова.');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            speakText('Геолокация не поддерживается вашим браузером. Вы можете выбрать место на карте вручную.');
        }
    }

    // Выбор локации на карте
    function selectLocationOnMap(latlng) {
        selectedLocation = {
            lat: latlng.lat,
            lng: latlng.lng
        };

        // Удаляем предыдущий маркер выбранного места
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
        }

        // Создаём новый маркер
        selectedLocationMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
            icon: L.divIcon({
                html: '<div style="background: #FF5722; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">📍</div>',
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);

        // Показываем информацию о выбранном месте
        document.getElementById('selectedCoords').textContent = 
            `Широта: ${selectedLocation.lat.toFixed(6)}, Долгота: ${selectedLocation.lng.toFixed(6)}`;
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('saveLocationBtn').disabled = false;

        speakText(`Место выбрано. Координаты: ${selectedLocation.lat.toFixed(3)}, ${selectedLocation.lng.toFixed(3)}`);
        
        // Если есть текущее местоположение, строим маршрут
        if (currentUserLocation) {
            calculateAndDisplayRoute(currentUserLocation, selectedLocation);
        }
    }

    // Настройка компаса
    function startCompassCalibration() {
        speakText('Начинаю калибровку компаса. Поверните устройство в виде восьмёрки.');
        document.getElementById('statusText').textContent = 'Калибровка компаса... Поверните устройство в виде восьмёрки';
        document.getElementById('calibrateBtn').disabled = true;

        // Симуляция калибровки компаса
        setTimeout(() => {
            fetch('/calibrate_compass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'calibrate' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isCompassCalibrated = true;
                    document.getElementById('statusText').textContent = 'Компас настроен! Теперь можно определить направление.';
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('calibrateBtn').textContent = '✅ Компас настроен';
                    speakText('Компас успешно настроен. Теперь нажмите кнопку определения направления.');
                }
            })
            .catch(error => {
                console.error('Ошибка калибровки:', error);
                document.getElementById('calibrateBtn').disabled = false;
                speakText('Ошибка калибровки компаса. Попробуйте ещё раз.');
            });
        }, 3000);
    }

    // Определение направления
    function captureView() {
        if (!isCompassCalibrated) {
            speakText('Сначала настройте компас');
            return;
        }

        speakText('Определяю направление взгляда с помощью камеры и искусственного интеллекта');
        document.getElementById('statusText').textContent = 'Определение направления...';
        document.getElementById('captureBtn').disabled = true;

        // Симуляция захвата изображения
        setTimeout(() => {
            fetch('/capture_view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'capture' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isDirectionCaptured = true;
                    document.getElementById('statusText').textContent = 'Направление определено! Можно начать навигацию.';
                    document.getElementById('captureBtn').textContent = '✅ Направление определено';
                    speakText('Направление успешно определено. Теперь можно выбрать место на карте или получить текущее местоположение.');
                }
            })
            .catch(error => {
                console.error('Ошибка определения направления:', error);
                document.getElementById('captureBtn').disabled = false;
                speakText('Ошибка определения направления. Попробуйте ещё раз.');
            });
        }, 2000);
    }

    // Получение текущего местоположения (кнопка)
    function getCurrentLocation() {
        speakText('Обновляю ваше местоположение');
        document.getElementById('statusText').textContent = 'Получение местоположения...';

        // Удаляем предыдущий маркер если есть
        if (currentLocationMarker) {
            map.removeLayer(currentLocationMarker);
        }

        // Используем функцию запроса геолокации
        requestUserLocation();
    }

    // Построение маршрута (эмуляция)
    function calculateAndDisplayRoute(origin, destination) {
        console.log('🛣️ Построение маршрута от', origin, 'до', destination);
        
        // Удаляем предыдущий маршрут
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }
        
        // Создаем эмулированный маршрут
        const route = generateEmulatedRoute(origin, destination);
        
        // Отображаем маршрут на карте
        const latlngs = route.path.map(point => [point.lat, point.lng]);
        routePolyline = L.polyline(latlngs, {
            color: '#FF0000',
            weight: 4,
            opacity: 0.8
        }).addTo(map);
        
        // Центрируем карту на маршруте
        map.fitBounds(routePolyline.getBounds());
        
        // Показываем информацию о маршруте
        document.getElementById('routeInfo').classList.remove('hidden');
        document.getElementById('routeDetails').innerHTML = `
            <div style="color: white; text-align: left;">
                <p><strong>🚶 Расстояние:</strong> ${route.legs[0].distance.text}</p>
                <p><strong>⏱️ Время в пути:</strong> ${route.legs[0].duration.text}</p>
                <p><strong>📍 От:</strong> ${route.legs[0].start_address}</p>
                <p><strong>🎯 До:</strong> ${route.legs[0].end_address}</p>
            </div>
        `;

        speakText(`Маршрут построен. Расстояние ${route.legs[0].distance.text}, время в пути ${route.legs[0].duration.text}`);
    }
    
    // Генерация эмулированного маршрута
    function generateEmulatedRoute(origin, destination) {
        const startLat = origin.lat;
        const startLng = origin.lng;
        const endLat = destination.lat;
        const endLng = destination.lng;
        
        // Вычисляем расстояние и время
        const distance = calculateDistance(startLat, startLng, endLat, endLng);
        const distanceMeters = Math.round(distance * 1000);
        const durationMinutes = Math.round(distanceMeters / 80); // ~5 км/ч пешком
        
        // Создаем путь с промежуточными точками для реалистичности
        const path = generateWalkingPath(startLat, startLng, endLat, endLng);
        
        // Генерируем адреса
        const startAddress = generateAlmatyAddress(startLat, startLng);
        const endAddress = generateAlmatyAddress(endLat, endLng);
        
        return {
            path: path,
            legs: [{
                distance: {
                    text: distanceMeters < 1000 ? `${distanceMeters} м` : `${(distance).toFixed(1)} км`,
                    value: distanceMeters
                },
                duration: {
                    text: durationMinutes < 60 ? `${durationMinutes} мин` : `${Math.floor(durationMinutes/60)} ч ${durationMinutes%60} мин`,
                    value: durationMinutes * 60
                },
                start_address: startAddress,
                end_address: endAddress
            }]
        };
    }
    
    // Генерация реалистичного пешеходного пути
    function generateWalkingPath(startLat, startLng, endLat, endLng) {
        const path = [];
        const steps = 8; // Количество промежуточных точек
        
        // Добавляем случайное отклонение для реалистичности
        const randomFactor = 0.001; // Максимальное отклонение
        
        for (let i = 0; i <= steps; i++) {
            const ratio = i / steps;
            
            // Интерполяция с небольшим случайным отклонением
            const lat = startLat + (endLat - startLat) * ratio + (Math.random() - 0.5) * randomFactor;
            const lng = startLng + (endLng - startLng) * ratio + (Math.random() - 0.5) * randomFactor;
            
            path.push({ lat: lat, lng: lng });
        }
        
        return path;
    }
    
    // Генерация адресов Алматы
    function generateAlmatyAddress(lat, lng) {
        const almatyStreets = [
            'проспект Абая', 'улица Сатпаева', 'проспект Аль-Фараби',
            'улица Толе би', 'проспект Назарбаева', 'улица Жибек Жолы',
            'проспект Достык', 'улица Манаса', 'улица Богенбай батыра',
            'проспект Райымбека', 'улица Курмангазы', 'улица Кабанбай батыра'
        ];
        
        // Выбираем улицу на основе координат (для консистентности)
        const streetIndex = Math.floor((lat + lng) * 1000) % almatyStreets.length;
        const street = almatyStreets[streetIndex];
        const houseNumber = Math.floor((lat + lng) * 10000) % 200 + 1;
        
        return `${street}, ${houseNumber}, Алматы`;
    }
    
    // Функция расчета расстояния
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Радиус Земли в км
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Сохранение места на карте
    function saveCurrentLocationOnMap() {
        if (!selectedLocation) {
            speakText('Сначала выберите место на карте');
            return;
        }
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        document.getElementById('locationName').focus();
    }

    // Сохранение выбранной локации
    function saveSelectedLocation() {
        const name = document.getElementById('locationName').value.trim();
        const description = document.getElementById('locationDescription').value.trim();
        const category = document.getElementById('locationCategory').value;

        if (!name) {
            speakText('Введите название места');
            document.getElementById('locationName').focus();
            return;
        }

        if (!selectedLocation) {
            speakText('Место не выбрано');
            return;
        }

        const locationData = {
            location: selectedLocation,
            name: name,
            description: description,
            category: category
        };

        fetch('/save_location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                speakText(`Место ${name} успешно сохранено`);
                clearSelection();
                loadSavedLocations();
                
                // Показываем уведомление со ссылкой
                showNotification(`Место сохранено! Статическая ссылка: ${data.static_url}`, 'success');
            } else {
                throw new Error(data.error || 'Ошибка сохранения');
            }
        })
        .catch(error => {
            console.error('Ошибка сохранения:', error);
            speakText('Ошибка при сохранении места');
        });
    }

    // Очистка выбора
    function clearSelection() {
        selectedLocation = null;
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        document.getElementById('selectedLocationInfo').classList.add('hidden');
        document.getElementById('saveLocationBtn').disabled = true;
        document.getElementById('locationName').value = '';
        document.getElementById('locationDescription').value = '';
        document.getElementById('locationCategory').value = 'general';
    }

    // Очистка карты
    function clearMap() {
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
            selectedLocationMarker = null;
        }
        if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
        }
        document.getElementById('routeInfo').classList.add('hidden');
        clearSelection();
        speakText('Карта очищена');
    }

    // Загрузка сохранённых мест
    async function loadSavedLocations() {
        try {
            const response = await fetch('/list_saved_locations');
            const data = await response.json();
            
            if (data.success && data.locations.length > 0) {
                savedLocations = data.locations;
                displaySavedLocations();
            } else {
                document.getElementById('savedLocationsList').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: white; padding: 40px;">
                        <p>🗺️ Пока нет сохранённых мест</p>
                        <p style="opacity: 0.7;">Нажмите на карту чтобы выбрать и сохранить место</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Ошибка загрузки сохранённых мест:', error);
        }
    }

    // Отображение сохранённых мест
    function displaySavedLocations() {
        const container = document.getElementById('savedLocationsList');
        container.innerHTML = savedLocations.map(location => `
            <div class="saved-location-card" onclick="selectSavedLocation('${location.id}')">
                <h4>${getCategoryIcon(location.category)} ${location.name}</h4>
                <p>${location.description || 'Без описания'}</p>
                <p style="font-size: 0.8em; opacity: 0.7;">
                    💾 ${formatDate(location.timestamp)} | 👁️ ${location.access_count}
                </p>
                <div class="location-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); navigateToSavedLocation('${location.id}')">
                        🧭 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); showOnMap('${location.id}')">
                        🗺️ 
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); copyLocationLink('${location.id}')">
                        🔗 
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Выбор сохранённого места
    function selectSavedLocation(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            selectedLocation = { lat: location.lat, lng: location.lng };
            selectLocationOnMap({ lat: location.lat, lng: location.lng });
            map.setView([location.lat, location.lng], 16);
            speakText(`Выбрано место ${location.name}`);
        }
    }

    // Показать место на карте
    function showOnMap(locationId) {
        const location = savedLocations.find(loc => loc.id === locationId);
        if (location) {
            map.setView([location.lat, location.lng], 17);
            
            const marker = L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    html: '<div style="background: #FF9800; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: bounce 2s 3;">📍</div>',
                    className: 'custom-div-icon',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                })
            }).addTo(map);

            setTimeout(() => map.removeLayer(marker), 6000);
            speakText(`Показываю место ${location.name} на карте`);
        }
    }

    // Навигация к сохранённому месту
    function navigateToSavedLocation(locationId) {
        window.location.href = `/location/${locationId}`;
    }

    // Копирование ссылки
    function copyLocationLink(locationId) {
        const link = `${window.location.origin}/location/${locationId}`;
        navigator.clipboard.writeText(link).then(() => {
            speakText('Ссылка скопирована в буфер обмена');
            showNotification('Ссылка скопирована!', 'success');
        }).catch(err => {
            console.error('Ошибка копирования:', err);
            speakText('Ошибка копирования ссылки');
        });
    }

    // Автоматическая навигация для статических ссылок
    function startAutoNavigation() {
        console.log('🎯 Начинаем автоматическую навигацию к:', window.destinationData);
        
        // Создаем объект места назначения в правильном формате
        const destination = {
            lat: window.destinationData.latitude, 
            lng: window.destinationData.longitude
        };
        
        // Устанавливаем место назначения глобально
        selectedLocation = destination;
        
        // СРАЗУ создаем и показываем маркер места назначения
        if (selectedLocationMarker) {
            map.removeLayer(selectedLocationMarker);
        }
        
        selectedLocationMarker = L.marker([destination.lat, destination.lng], {
            icon: L.divIcon({
                html: `<div style="
                    background: linear-gradient(45deg, #FF5722, #E64A19); 
                    color: white; 
                    border-radius: 50%; 
                    width: 45px; 
                    height: 45px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    border: 3px solid white; 
                    box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6);
                    animation: destinationPulse 2s infinite;
                    font-size: 20px;
                ">🎯</div>
                <style>
                @keyframes destinationPulse {
                    0% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6); }
                    50% { transform: scale(1.15); box-shadow: 0 6px 30px rgba(255, 87, 34, 0.8); }
                    100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 87, 34, 0.6); }
                }
                </style>`,
                className: 'destination-marker',
                iconSize: [45, 45],
                iconAnchor: [22, 22]
            })
        }).addTo(map);
        
        // Получаем ТОЧНЫЙ адрес для места назначения из координат
        getExactAddress(destination.lat, destination.lng).then(exactAddress => {
            // Немедленно объявляем о начале навигации с ТОЧНЫМ адресом
            speakText(`Автоматически строю маршрут до места ${window.destinationData.name}, точный адрес: ${exactAddress}. Начинаю калибровку компаса и определение направления.`);
            
            // Добавляем информативную всплывающую подсказку с точным адресом
            selectedLocationMarker.bindPopup(`
                <div style="text-align: center; font-weight: bold; min-width: 250px;">
                    <div style="font-size: 18px; color: #FF5722; margin-bottom: 8px;">
                        🎯 ${window.destinationData.name}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                        ${window.destinationData.description || 'Место назначения'}
                    </div>
                    <div style="font-size: 12px; color: #444; margin-bottom: 8px; background: #f0f0f0; padding: 8px; border-radius: 6px;">
                        📍 <strong>Точный адрес:</strong><br>${exactAddress}
                    </div>
                    <div style="font-size: 11px; color: #999;">
                        Широта: ${destination.lat.toFixed(6)}<br>
                        Долгота: ${destination.lng.toFixed(6)}
                    </div>
                    <div style="margin-top: 8px; padding: 4px 8px; background: #FF5722; color: white; border-radius: 12px; font-size: 10px;">
                        Автоматическая навигация
                    </div>
                </div>
            `).openPopup();
        });
        
        // Показываем информацию о выбранном месте
        document.getElementById('selectedCoords').textContent = 
            `Широта: ${destination.lat.toFixed(6)}, Долгота: ${destination.lng.toFixed(6)}`;
        document.getElementById('selectedLocationInfo').classList.remove('hidden');
        
        // Заполняем поля информации о месте
        document.getElementById('locationName').value = window.destinationData.name;
        document.getElementById('locationDescription').value = window.destinationData.description || '';
        document.getElementById('locationCategory').value = window.destinationData.category || 'general';
        
        // Отключаем кнопку сохранения (место уже сохранено)
        document.getElementById('saveLocationBtn').disabled = true;
        document.getElementById('saveLocationBtn').textContent = '✅ Уже сохранено';
        
        // СНАЧАЛА центрируем карту на место назначения
        map.setView([destination.lat, destination.lng], 16);
        
        // АВТОМАТИЧЕСКИ получаем геолокацию пользователя (это покажет оба маркера)
        setTimeout(() => {
            requestUserLocation();
        }, 1000);
        
        // АВТОМАТИЧЕСКАЯ КАЛИБРОВКА КОМПАСА (без участия пользователя)
        setTimeout(() => {
            autoCompassCalibration();
        }, 2000);
    }

    // Функция получения точного адреса по координатам
    async function getExactAddress(lat, lng) {
        try {
            // Используем Nominatim API для получения точного адреса
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lng=${lng}&zoom=18&addressdetails=1&accept-language=ru`);
            const data = await response.json();
            
            if (data && data.display_name) {
                // Парсим и форматируем адрес для лучшей читаемости
                const address = data.address || {};
                let formattedAddress = '';
                
                if (address.road) formattedAddress += address.road;
                if (address.house_number) formattedAddress += `, ${address.house_number}`;
                if (address.suburb) formattedAddress += `, район ${address.suburb}`;
                if (address.city || address.town) formattedAddress += `, ${address.city || address.town}`;
                
                return formattedAddress || data.display_name;
            }
        } catch (error) {
            console.error('Ошибка получения адреса:', error);
        }
        
        // Fallback - генерируем адрес как раньше
        return generateAlmatyAddress(lat, lng);
    }

    // Автоматическая калибровка компаса (без участия пользователя)
    function autoCompassCalibration() {
        speakText('Автоматически настраиваю компас');
        document.getElementById('statusText').textContent = 'Автоматическая калибровка компаса...';
        document.getElementById('calibrateBtn').disabled = true;
        document.getElementById('calibrateBtn').textContent = '⏳ Калибровка...';

        // Эмуляция автоматической калибровки
        setTimeout(() => {
            fetch('/calibrate_compass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'calibrate' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isCompassCalibrated = true;
                    document.getElementById('statusText').textContent = 'Компас настроен автоматически!';
                    document.getElementById('calibrateBtn').textContent = '✅ Компас настроен';
                    speakText('Компас настроен. Определяю направление.');
                    
                    // Автоматически переходим к определению направления
                    setTimeout(() => {
                        autoCaptureView();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Ошибка автоматической калибровки:', error);
                speakText('Ошибка калибровки компаса. Продолжаю без калибровки.');
                // Продолжаем даже при ошибке
                setTimeout(() => {
                    autoCaptureView();
                }, 1000);
            });
        }, 2000);
    }

    // Автоматическое определение направления (без участия пользователя)
    function autoCaptureView() {
        speakText('Автоматически определяю направление взгляда');
        document.getElementById('statusText').textContent = 'Автоматическое определение направления...';
        document.getElementById('captureBtn').disabled = true;
        document.getElementById('captureBtn').textContent = '⏳ Определение...';

        // Эмуляция автоматического определения направления
        setTimeout(() => {
            fetch('/capture_view', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'capture' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isDirectionCaptured = true;
                    document.getElementById('statusText').textContent = 'Направление определено автоматически! Готов к навигации.';
                    document.getElementById('captureBtn').textContent = '✅ Направление определено';
                    speakText('Направление определено. Система готова к навигации. Получаю ваше местоположение для построения маршрута.');
                    
                    // Если геолокация еще не получена, ждем ее
                    if (!currentUserLocation) {
                        // Дополнительная попытка получить геолокацию
                        requestUserLocation();
                    } else {
                        // Если геолокация уже есть, строим маршрут
                        calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                        speakText(`Маршрут построен. Начинаю голосовую навигацию к месту ${window.destinationData.name}.`);
                    }
                }
            })
            .catch(error => {
                console.error('Ошибка автоматического определения направления:', error);
                speakText('Ошибка определения направления. Продолжаю навигацию.');
                // Продолжаем даже при ошибке
                if (!currentUserLocation) {
                    requestUserLocation();
                } else {
                    calculateAndDisplayRoute(currentUserLocation, selectedLocation);
                }
            });
        }, 2000);
    }

    // Начало голосовой навигации
    function startNavigation() {
        if (!currentUserLocation || !selectedLocation) {
            speakText('Для начала навигации нужно определить ваше местоположение и выбрать пункт назначения');
            return;
        }
        
        // Вычисляем расстояние и направление
        const distance = calculateDistance(
            currentUserLocation.lat, currentUserLocation.lng, 
            selectedLocation.lat, selectedLocation.lng
        );
        
        const bearing = calculateBearing(
            currentUserLocation.lat, currentUserLocation.lng,
            selectedLocation.lat, selectedLocation.lng
        );
        
        const direction = getDirectionFromBearing(bearing);
        const distanceText = distance < 1 ? `${Math.round(distance * 1000)} метров` : `${distance.toFixed(1)} километров`;
        
        if (window.destinationData) {
            // Для автоматической навигации - детальные инструкции
            speakText(`Начинаю голосовую навигацию к месту ${window.destinationData.name}. Расстояние до цели: ${distanceText}. Направление: ${direction}. Идите прямо, я буду вас сопровождать голосовыми подсказками. Для получения текущего направления скажите "Где я" или нажмите кнопку микрофона.`);
            
            // Запускаем периодические обновления навигации
            startPeriodicNavigation();
        } else {
            speakText(`Начинаю голосовую навигацию. Расстояние: ${distanceText}, направление: ${direction}. Следуйте голосовым указаниям.`);
        }
    }

    // Периодическая навигация (каждые 30 секунд)
    function startPeriodicNavigation() {
        const navigationInterval = setInterval(() => {
            if (!currentUserLocation || !selectedLocation) {
                clearInterval(navigationInterval);
                return;
            }
            
            // Обновляем текущее местоположение
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    const distance = calculateDistance(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    // Если прибыли к месту назначения (в радиусе 50 метров)
                    if (distance < 0.05) {
                        clearInterval(navigationInterval);
                        speakText(`Вы прибыли к месту назначения: ${window.destinationData ? window.destinationData.name : 'выбранное место'}. Навигация завершена.`);
                        return;
                    }
                    
                    // Обновляем направление
                    const bearing = calculateBearing(
                        newLocation.lat, newLocation.lng,
                        selectedLocation.lat, selectedLocation.lng
                    );
                    
                    const direction = getDirectionFromBearing(bearing);
                    const distanceText = distance < 1 ? `${Math.round(distance * 1000)} метров` : `${distance.toFixed(1)} километров`;
                    
                    speakText(`Продолжайте движение. До цели: ${distanceText}. Направление: ${direction}.`);
                },
                (error) => {
                    console.log('Ошибка обновления геолокации:', error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 10000 }
            );
        }, 30000); // Каждые 30 секунд
    }

    // Вычисление направления по азимуту
    function calculateBearing(lat1, lng1, lat2, lng2) {
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const lat1Rad = lat1 * Math.PI / 180;
        const lat2Rad = lat2 * Math.PI / 180;
        
        const y = Math.sin(dLng) * Math.cos(lat2Rad);
        const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                  Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
        
        const bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360;
    }

    // Преобразование азимута в понятное направление
    function getDirectionFromBearing(bearing) {
        const directions = [
            'север', 'северо-восток', 'восток', 'юго-восток',
            'юг', 'юго-запад', 'запад', 'северо-запад'
        ];
        
        const index = Math.round(bearing / 45) % 8;
        return `на ${directions[index]}`;
    }

    // Вспомогательные функции
    function getCategoryIcon(category) {
        const icons = {
            'general': '📍', 'home': '🏠', 'work': '🏢', 'shop': '🛒',
            'medical': '🏥', 'education': '🎓', 'transport': '🚌',
            'food': '🍽️', 'entertainment': '🎬'
        };
        return icons[category] || '📍';
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // Инициализация при загрузке DOM
    document.addEventListener('DOMContentLoaded', function() {
        // Ждем загрузки Leaflet
        if (typeof L !== 'undefined') {
            initMaps();
        } else {
            setTimeout(() => {
                if (typeof L !== 'undefined') {
                    initMaps();
                } else {
                    console.error('Leaflet не загружен');
                    speakText('Ошибка загрузки карты');
                }
            }, 1000);
        }
    });

    // Добавляем анимацию для маркеров
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    `;
    document.head.appendChild(style);
</script>

    </div>
    
    <!-- Глобальная панель голосового управления -->
    <div class="global-voice-panel" role="region" aria-label="Голосовое управление">
        <button id="globalVoiceBtn" class="global-voice-btn focusable" 
                aria-label="Начать голосовую команду" 
                title="Нажмите для записи голосовой команды">
            🎤
        </button>
        
        <!-- Индикатор статуса микрофона -->
        <div id="microphoneStatus" class="microphone-status" style="display: none;">
            <span id="micStatusIcon">🎤</span>
            <span id="micStatusText">Микрофон готов</span>
        </div>
        
        <!-- Инструкции по использованию -->
        <div id="voiceInstructions" class="voice-instructions" style="display: none;">
            <div class="instruction-content">
                <h3>🎤 Голосовое управление</h3>
                <ul>
                    <li>Нажмите кнопку микрофона или клавишу Пробел</li>
                    <li>Разрешите доступ к микрофону в браузере</li>
                    <li>Говорите четко и громко</li>
                    <li>Нажмите еще раз чтобы остановить запись</li>
                    <li>Нажмите Escape для отмены</li>
                </ul>
                <button onclick="hideInstructions()" class="btn">Понятно</button>
            </div>
        </div>
    </div>
    
    <!-- Базовая JavaScript функциональность -->
    <script>
        // Глобальные переменные для голосового управления
        let isListening = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoiceControls();
            initializeAccessibility();
            announcePageLoad();
            checkMicrophoneSupport();
        });
        
        // Инициализация голосового управления
        function initializeVoiceControls() {
            const globalVoiceBtn = document.getElementById('globalVoiceBtn');
            if (globalVoiceBtn) {
                globalVoiceBtn.addEventListener('click', toggleGlobalVoice);
            }
        }
        
        // Переключение глобального голосового управления
        async function toggleGlobalVoice() {
            if (isListening) {
                stopListening();
            } else {
                await startListening();
            }
        }
        
        // Начало записи голоса
        async function startListening() {
            try {
                // Проверка поддержки браузера
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Ваш браузер не поддерживает запись аудио. Попробуйте использовать Chrome, Firefox или Safari.');
                }

                // Проверка поддержки MediaRecorder
                if (!window.MediaRecorder) {
                    throw new Error('Ваш браузер не поддерживает запись медиа. Обновите браузер до последней версии.');
                }

                showVoiceStatus('Запрашиваю доступ к микрофону...');
                speakText('Запрашиваю разрешение на использование микрофона');

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                // Проверка доступных MIME типов
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = ''; // Использовать тип по умолчанию
                        }
                    }
                }

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    processVoiceCommand();
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    showNotification('Ошибка записи аудио: ' + event.error.message, 'error');
                    resetVoiceButton();
                };
                
                mediaRecorder.start();
                isListening = true;
                
                const voiceBtn = document.getElementById('globalVoiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.add('listening');
                    voiceBtn.innerHTML = '⏹️';
                    voiceBtn.setAttribute('aria-label', 'Остановить запись голосовой команды');
                }
                
                showVoiceStatus('Слушаю... Говорите сейчас!');
                speakText('Микрофон активен. Говорите вашу команду.');
                
                // Автоматическая остановка через 30 секунд
                setTimeout(() => {
                    if (isListening) {
                        stopListening();
                        speakText('Время записи истекло. Попробуйте еще раз.');
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Ошибка доступа к микрофону:', error);
                
                let errorMessage = 'Ошибка доступа к микрофону. ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'Разрешите доступ к микрофону в настройках браузера и перезагрузите страницу.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'Микрофон не найден. Подключите микрофон и попробуйте еще раз.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'Микрофон используется другим приложением. Закройте другие приложения и попробуйте еще раз.';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += 'Настройки микрофона не поддерживаются. Попробуйте использовать другой браузер.';
                } else {
                    errorMessage += error.message || 'Неизвестная ошибка.';
                }
                
                showNotification(errorMessage, 'error');
                speakText('Не удалось получить доступ к микрофону. Проверьте разрешения в браузере.');
                resetVoiceButton();
            }
        }
        
        // Остановка записи голоса
        function stopListening() {
            if (mediaRecorder && isListening) {
                try {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    console.error('Ошибка остановки записи:', error);
                }
                
                isListening = false;
                
                const voiceBtn = document.getElementById('globalVoiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.remove('listening');
                    voiceBtn.innerHTML = '🎤';
                    voiceBtn.setAttribute('aria-label', 'Начать голосовую команду');
                }
                
                showVoiceStatus('Обрабатываю команду...');
            }
        }
        
        // Обработка голосовой команды (переопределяется на других страницах)
        function processVoiceCommand() {
            try {
                // Базовая обработка - будет переопределена на специфичных страницах
                console.log('Обработка голосовой команды...');
                
                const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                
                if (audioBlob.size === 0) {
                    throw new Error('Нет записанных аудиоданных. Попробуйте записать еще раз.');
                }
                
                console.log('Аудио записано:', audioBlob.size, 'байт');
                speakText('Команда записана успешно');
                
            } catch (error) {
                console.error('Ошибка обработки голосовой команды:', error);
                showNotification('Ошибка: ' + error.message, 'error');
                speakText('Ошибка обработки команды. Попробуйте еще раз.');
            } finally {
                hideVoiceStatus();
            }
        }
        
        // Показ статуса голосового ассистента
        function showVoiceStatus(text) {
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceStatusText = document.getElementById('voiceStatusText');
            voiceStatusText.textContent = text;
            voiceStatus.classList.add('show');
        }
        
        // Скрытие статуса голосового ассистента
        function hideVoiceStatus() {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.classList.remove('show');
        }
        
        // Показ уведомлений
        function showNotification(text, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Синтез речи
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }
        
        // Инициализация доступности
        function initializeAccessibility() {
            // Добавление ARIA-меток
            const focusableElements = document.querySelectorAll('.focusable');
            focusableElements.forEach(element => {
                if (!element.getAttribute('tabindex')) {
                    element.setAttribute('tabindex', '0');
                }
            });
            
            // Обработка клавиатурной навигации
            document.addEventListener('keydown', handleKeyboardNavigation);
        }
        
        // Обработка клавиатурной навигации
        function handleKeyboardNavigation(event) {
            // Пробел или Enter для активации голосового управления
            if ((event.code === 'Space' || event.code === 'Enter') && 
                event.target.id === 'globalVoiceBtn') {
                event.preventDefault();
                toggleGlobalVoice();
            }
            
            // Escape для отмены записи
            if (event.code === 'Escape' && isListening) {
                stopListening();
                speakText('Запись отменена');
            }
        }
        
        // Объявление загрузки страницы
        function announcePageLoad() {
            const pageTitle = document.querySelector('.main-header h1');
            if (pageTitle) {
                setTimeout(() => {
                    speakText(`Страница загружена: ${pageTitle.textContent}`);
                }, 1000);
            }
        }
        
        // Утилиты для работы с геолокацией
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Геолокация не поддерживается'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    error => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }
        
        // Анимации появления элементов
        function animateElements() {
            const elements = document.querySelectorAll('.nav-card, .btn');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('animate-in');
                }, index * 100);
            });
        }
        
        // Запуск анимаций после загрузки
        window.addEventListener('load', animateElements);
        
        // Сброс кнопки голосового управления
        function resetVoiceButton() {
            isListening = false;
            const voiceBtn = document.getElementById('globalVoiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = '🎤';
                voiceBtn.setAttribute('aria-label', 'Начать голосовую команду');
            }
            hideVoiceStatus();
        }

        // Проверка поддержки микрофона
        function checkMicrophoneSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showMicrophoneStatus('Микрофон не поддерживается', 'error');
                speakText('Ваш браузер не поддерживает запись аудио');
                return;
            }
            
            if (!window.MediaRecorder) {
                showMicrophoneStatus('Запись не поддерживается', 'error');
                speakText('Ваш браузер не поддерживает запись медиа');
                return;
            }
            
            // Проверка разрешений микрофона
            navigator.permissions.query({ name: 'microphone' }).then(function(result) {
                if (result.state === 'granted') {
                    showMicrophoneStatus('Микрофон готов', 'success');
                } else if (result.state === 'prompt') {
                    showMicrophoneStatus('Нажмите кнопку для доступа', '');
                } else {
                    showMicrophoneStatus('Доступ запрещен', 'error');
                    showInstructions();
                }
            }).catch(function(error) {
                console.log('Permissions API не поддерживается:', error);
                showMicrophoneStatus('Нажмите кнопку для начала', '');
            });
        }

        // Показ статуса микрофона
        function showMicrophoneStatus(text, type) {
            const statusElement = document.getElementById('microphoneStatus');
            const iconElement = document.getElementById('micStatusIcon');
            const textElement = document.getElementById('micStatusText');
            
            if (statusElement && iconElement && textElement) {
                textElement.textContent = text;
                statusElement.className = `microphone-status ${type}`;
                
                if (type === 'error') {
                    iconElement.textContent = '❌';
                } else if (type === 'success') {
                    iconElement.textContent = '✅';
                } else {
                    iconElement.textContent = '🎤';
                }
                
                statusElement.style.display = 'flex';
                
                // Автоматически скрыть через 5 секунд
                setTimeout(() => {
                    if (type !== 'error') {
                        statusElement.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // Показ инструкций
        function showInstructions() {
            const instructionsElement = document.getElementById('voiceInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'flex';
                speakText('Показаны инструкции по использованию голосового управления');
            }
        }

        // Скрытие инструкций
        function hideInstructions() {
            const instructionsElement = document.getElementById('voiceInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'none';
                speakText('Инструкции закрыты');
            }
        }
    </script>
    
    
</body>
</html> 